<!DOCTYPE html>
<html lang="my">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>စရိတ်စာရင်း - အိမ်သုံးစရိတ် စီမံခန့်ခွဲမှု</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%; /* Ensure html and body take full viewport height */
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent body scrollbar, app-container will handle its own scroll */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            box-sizing: border-box;
        }
        #app-container {
            background-color: #ffffff;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 400px; /* Typical mobile width */
            height: 100%; /* Make app-container take full height of its parent (body) */
            max-height: 800px; /* Cap max height for larger screens if needed */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Crucial to clip content at rounded corners, esp. for fixed nav */
            position: relative; /* Essential for positioning the fixed-nav-bar relative to this container */
        }
        /* Style for the new header/balance card */
        #balance-card {
            background-color: #4f46e5; /* Indigo-600 background for the header */
            color: #ffffff; /* White text */
            padding: 25px 20px; /* Adjusted padding */
            border-radius: 20px 20px 0 0; /* Only top corners rounded */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); /* Subtle shadow */
            text-align: center;
            margin-bottom: 0; /* No margin at the bottom of the card */
        }
        #balance-card #total-balance {
            font-size: 3rem; /* Larger font for balance */
            font-weight: 800; /* Extra bold */
            line-height: 1.2;
            margin-top: 5px;
        }
        #balance-card .balance-label {
            font-size: 0.875rem; /* text-sm */
            opacity: 0.9;
            margin-bottom: 5px;
        }
        /* User ID display element only */
        .user-info {
            font-size: 0.75rem; /* text-xs */
            opacity: 0.8;
            margin-top: 5px;
        }

        .screen {
            display: none; /* Hide all screens by default */
            flex-grow: 1; /* Allows screen content to take available vertical space */
            padding: 20px;
            padding-top: 20px; /* Restore top padding for screen content */
            /* Calculate padding-bottom: Nav bar height (~70px) + extra bottom padding (e.g., 2 lines of text ~48px) = ~118px. Let's use 120px. */
            padding-bottom: 120px; /* Ensures content doesn't get hidden behind the fixed nav bar */
            overflow-y: auto; /* Allows content within each screen to scroll independently */
            -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        }
        .screen.active {
            display: flex; /* Show active screen */
            flex-direction: column;
        }
        .fixed-nav-bar {
            position: absolute; /* Positioned relative to its parent (#app-container) */
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 10; /* Ensure it's on top of other content */
        }
        .nav-button {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px 0; /* This padding contributes to the nav bar's height */
            color: #6b7280;
            font-size: 0.75rem; /* text-xs */
            font-weight: 500; /* font-medium */
            transition: color 0.2s ease-in-out;
        }
        .nav-button.active {
            color: #4f46e5; /* indigo-600 */
        }
        .nav-button svg {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
        }
        /* Custom scrollbar for better UX */
        .screen::-webkit-scrollbar {
            width: 8px;
        }
        .screen::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .screen::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .screen::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* Visual space indicator */
        .bottom-space-indicator {
            height: 48px; /* Roughly two lines of text height */
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            font-size: 0.8rem;
            margin-top: 20px; /* Space above this indicator */
        }

        /* Styles for the new type selection buttons */
        .type-button {
            flex: 1;
            padding: 12px 0;
            border-radius: 9999px; /* Full rounded for circular/pill shape */
            font-weight: 600; /* font-semibold */
            text-align: center;
            transition: all 0.2s ease-in-out;
            border: 2px solid transparent; /* Default transparent border */
        }
        .type-button.expense {
            background-color: #fee2e2; /* red-100 */
            color: #dc2626; /* red-600 */
        }
        .type-button.income {
            background-color: #dcfce7; /* green-100 */
            color: #16a34a; /* green-600 */
        }
        .type-button.selected {
            border-color: #4f46e5; /* indigo-600 border when selected */
            box-shadow: 0 4px 10px rgba(79, 70, 229, 0.2); /* Subtle shadow when selected */
            transform: translateY(-2px); /* Slight lift effect */
        }
        /* Style for the category selection button */
        .category-select-button {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.75rem; /* rounded-xl */
            background-color: #ffffff;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        .category-select-button:focus {
            outline: none;
            border-color: #6366f1; /* indigo-500 */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); /* focus:ring-indigo-500 */
        }
        .category-select-button .placeholder-text {
            color: #6b7280; /* gray-500 */
        }
        .category-select-button .selected-text {
            color: #1f2937; /* gray-800 */
            font-weight: 500; /* font-medium */
        }

        /* Style for the date selection button */
        .date-button {
            display: flex;
            align-items: center;
            justify-content: center; /* Center content horizontally */
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 9999px; /* Full rounded for pill shape */
            background-color: #ffffff;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* shadow-sm */
            cursor: pointer;
            transition: border-color 0.2s, box-shadow 0.2s;
            font-weight: 500; /* font-medium */
            color: #1f2937; /* gray-800 */
        }
        .date-button:focus {
            outline: none;
            border-color: #6366f1; /* indigo-500 */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); /* focus:ring-indigo-500 */
        }
        .date-button svg {
            width: 24px;
            height: 24px;
            color: #4f46e5; /* indigo-600 */
            margin-right: 8px; /* Space between icon and text */
        }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- Balance Card (Now acting as Header) -->
        <div id="balance-card">
            <div class="balance-label">လက်ရှိလက်ကျန်ငွေ</div>
            <div id="total-balance" class="font-extrabold">၀.၀၀</div>
            <!-- User ID display element only -->
            <div class="user-info">
                <span id="user-id-display" class="block">User ID: N/A</span>
            </div>
        </div>

        <!-- Screens -->
        <div id="dashboard-screen" class="screen active">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">မကြာသေးမီက မှတ်တမ်းများ</h2>
            <div id="recent-transactions" class="space-y-3 flex-grow">
                <!-- Recent transactions will be loaded here -->
                <p class="text-gray-500 text-center mt-8">မှတ်တမ်းများ မရှိသေးပါ</p>
            </div>
            <div class="bottom-space-indicator"></div>
        </div>

        <div id="add-transaction-screen" class="screen">
            <form id="transaction-form" class="space-y-5">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">အမျိုးအစား</label>
                    <div class="flex space-x-4">
                        <button type="button" id="expense-type-btn" class="type-button expense selected" data-type="expense">
                            ထွက်ငွေ
                        </button>
                        <button type="button" id="income-type-btn" class="type-button income" data-type="income">
                            ဝင်ငွေ
                        </button>
                    </div>
                    <!-- Hidden input to store the selected type for form submission -->
                    <input type="hidden" id="transaction-type" name="transaction-type" value="expense">
                </div>
                <div>
                    <label for="transaction-amount" class="block text-sm font-medium text-gray-700 mb-1">ပမာဏ</label>
                    <input type="number" id="transaction-amount" placeholder="ဥပမာ: ၅၀၀၀" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 shadow-sm" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">အမျိုးအစားခွဲ</label>
                    <div id="category-select-button" class="category-select-button">
                        <span id="selected-category-text" class="placeholder-text">အမျိုးအစား ရွေးချယ်ပါ</span>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5 text-gray-400">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 15L12 18.75 15.75 15m-7.5-6L12 5.25 15.75 9" />
                        </svg>
                    </div>
                    <!-- Hidden input to store the selected category for form submission -->
                    <input type="hidden" id="transaction-category" name="transaction-category" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ရက်စွဲ</label>
                    <button type="button" id="date-select-button" class="date-button">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5m-9-6h.008v.008H12v-.008zM12 15h.008v.008H12v-.008zM12 18h.008v.008H12v-.008z" />
                        </svg>
                        <span id="selected-date-text">ရက်စွဲ ရွေးချယ်ပါ</span>
                    </button>
                    <!-- Hidden input to actually handle the date selection and store the value -->
                    <input type="date" id="hidden-transaction-date" class="hidden" required>
                </div>
                <div>
                    <label for="transaction-description" class="block text-sm font-medium text-gray-700 mb-1">ဖော်ပြချက် (optional)</label>
                    <textarea id="transaction-description" rows="2" placeholder="ဥပမာ: မနက်စာ ထမင်းကြော်" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 shadow-sm"></textarea>
                </div>
                <button type="submit" class="w-full py-3 bg-indigo-600 text-white font-semibold rounded-xl shadow-lg hover:bg-indigo-700 transition duration-300">
                    မှတ်တမ်းတင်မည်
                </button>
            </form>
            <div class="bottom-space-indicator"></div>
        </div>

        <div id="transactions-list-screen" class="screen">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">မှတ်တမ်းများ အားလုံး</h2>
            <div class="mb-4 flex space-x-2">
                <select id="filter-month" class="p-2 border border-gray-300 rounded-lg text-sm">
                    <option value="">လ အားလုံး</option>
                    <!-- Months will be populated by JS -->
                </select>
                <select id="filter-category" class="p-2 border border-gray-300 rounded-lg text-sm flex-grow">
                    <option value="">အမျိုးအစား အားလုံး</option>
                    <!-- Categories will be populated by JS -->
                </select>
            </div>
            <div id="all-transactions" class="space-y-3 flex-grow">
                <!-- All transactions will be loaded here -->
                <p class="text-gray-500 text-center mt-8">မှတ်တမ်းများ မရှိသေးပါ</p>
            </div>
            <div class="bottom-space-indicator"></div>
        </div>

        <div id="reports-screen" class="screen">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">အစီရင်ခံစာများ</h2>
            <div class="mb-4">
                <label for="report-month-select" class="block text-sm font-medium text-gray-700 mb-1">လ ရွေးချယ်ပါ</label>
                <select id="report-month-select" class="w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                    <!-- Months will be populated by JS -->
                </select>
            </div>

            <div class="bg-gray-50 p-4 rounded-xl shadow-sm mb-4">
                <h3 class="text-lg font-medium text-gray-800 mb-2">လစဉ် ခြုံငုံသုံးသပ်ချက်</h3>
                <p class="text-gray-700 mb-1">ဝင်ငွေစုစုပေါင်း: <span id="report-total-income" class="font-semibold text-green-600">၀.၀၀</span></p>
                <p class="text-gray-700">ထွက်ငွေစုစုပေါင်း: <span id="report-total-expense" class="font-semibold text-red-600">၀.၀၀</span></p>
            </div>

            <h3 class="text-lg font-medium text-gray-800 mb-3">အမျိုးအစားအလိုက် ထွက်ငွေ</h3>
            <div id="category-expense-chart" class="w-full h-48 bg-gray-50 rounded-xl flex items-center justify-center text-gray-500">
                <!-- Chart placeholder or actual chart will go here -->
                <p>အချက်အလက် မရှိသေးပါ</p>
            </div>
            <div id="category-expense-list" class="mt-4 space-y-2">
                <!-- Category wise expense list will be loaded here -->
            </div>
            <div class="bottom-space-indicator"></div>
        </div>

        <div id="categories-screen" class="screen">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">အမျိုးအစားများ စီမံခန့်ခွဲရန်</h2>
            <div class="mb-4 flex items-center space-x-2">
                <input type="text" id="new-category-input" placeholder="အမျိုးအစားအသစ် ထည့်ပါ" class="flex-grow p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                <button id="add-category-btn" class="p-3 bg-indigo-600 text-white rounded-xl shadow-md hover:bg-indigo-700 transition duration-300">
                    ထည့်မည်
                </button>
            </div>
            <div id="category-list" class="space-y-2 flex-grow">
                <!-- Categories will be loaded here -->
            </div>
            <div class="bottom-space-indicator"></div>
        </div>

        <!-- Navigation Bar (Fixed at bottom of app-container) -->
        <div class="fixed-nav-bar flex justify-around bg-white border-t border-gray-200 p-2 shadow-lg">
            <button class="nav-button active" data-screen="dashboard-screen">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125h9.75a1.125 1.125 0 001.125-1.125V9.75M8.25 21h8.25" />
                </svg>
                <span>ပင်မ</span>
            </button>
            <button class="nav-button" data-screen="add-transaction-screen">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>ထည့်သွင်း</span>
            </button>
            <button class="nav-button" data-screen="transactions-list-screen">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 21h2.25m-1.5-18v2.25m-3.75 9h1.5m-1.5 3H12M9 16.5h3.75m-9 .75h9.75A2.25 2.25 0 0021 17.25V6.75A2.25 2.25 0 0018.75 4.5H5.25A2.25 2.25 0 003 6.75v10.5A2.25 2.25 0 005.25 19.5z" />
                </svg>
                <span>မှတ်တမ်း</span>
            </button>
            <button class="nav-button" data-screen="reports-screen">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6a7.5 7.5 0 107.5 7.5h-7.5V6z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 10.5H21A7.5 7.5 0 0013.5 3v7.5z" />
                </svg>
                <span>အစီရင်ခံစာ</span>
            </button>
            <button class="nav-button" data-screen="categories-screen">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 00-5.78 1.124A2.25 2.25 0 012.25 18V21m12.75-18v2.25c0 .621.504 1.125 1.125 1.125H21a2.25 2.25 0 012.25 2.25v1.372c0 .516-.351.966-.852 1.106a8.967 8.967 0 01-4.486 0 2.25 2.25 0 00-.852-1.106V6.75c0-.621-.504-1.125-1.125-1.125h-1.5zm-6 11.25l.896-1.436A4.5 4.5 0 0011.5 15h1.5a4.5 4.5 0 00-.896-1.436L9.53 16.122zm-2.25-5.622a4.5 4.5 0 00-5.78 1.124 2.25 2.25 0 01-1.124-.574V7.5c0-1.036.84-1.875 1.875-1.875h.375m9 1.5l.896-1.436A4.5 4.5 0 0018.5 15h1.5a4.5 4.5 0 00-.896-1.436L16.78 10.5zm-2.25-5.622a4.5 4.5 0 00-5.78 1.124 2.25 2.25 0 01-1.124-.574V7.5c0-1.036.84-1.875 1.875-1.875h.375" />
                </svg>
                <span>အမျိုးအစား</span>
            </button>
        </div>
    </div>

    <!-- Custom Alert/Confirmation Modal -->
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-sm">
            <h3 id="modal-title" class="text-xl font-semibold mb-4 text-gray-800"></h3>
            <p id="modal-message" class="text-gray-700 mb-6"></p>
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="px-5 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition duration-300">မလုပ်တော့ပါ</button>
                <button id="modal-confirm-btn" class="px-5 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-300">ဖျက်မည်</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, orderBy, onSnapshot, addDoc, deleteDoc, doc, setDoc, getDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your provided Firebase configuration - now hardcoded
        const firebaseConfig = {
            apiKey: "AIzaSyDUf0QF4GqMb6s9ODTUiX7aTHRTR0YUqcE",
            authDomain: "html-3ce83.firebaseapp.com",
            databaseURL: "https://html-3ce83-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "html-3ce83",
            storageBucket: "html-3ce83.firebasestorage.app",
            messagingSenderId: "602585837585",
            appId: "1:602585837585:web:415bd8bcc59b4cbd4d81b0",
            measurementId: "G-QBME7CRR2X"
        };

        // Using appId directly from the provided firebaseConfig
        const appId = firebaseConfig.appId;

        // Firebase instances
        let app;
        let db;
        let auth;
        let currentUserId = null; // Stores the authenticated user's ID
        let isAuthReady = false; // Flag to ensure Firestore operations only happen after authentication

        // Data storage (now populated by Firestore listeners)
        let transactions = [];
        let categories = [];

        // Global variable to store the selected category when returning from categories screen
        let selectedCategoryForForm = '';

        // DOM Elements
        const totalBalanceEl = document.getElementById('total-balance');
        const screens = document.querySelectorAll('.screen');
        const navButtons = document.querySelectorAll('.nav-button');
        const transactionForm = document.getElementById('transaction-form');
        const transactionAmountEl = document.getElementById('transaction-amount');
        const hiddenTransactionDateInput = document.getElementById('hidden-transaction-date');
        const transactionDescriptionEl = document.getElementById('transaction-description');
        const recentTransactionsEl = document.getElementById('recent-transactions');
        const allTransactionsEl = document.getElementById('all-transactions');
        const filterMonthEl = document.getElementById('filter-month');
        const filterCategoryEl = document.getElementById('filter-category');
        const reportMonthSelectEl = document.getElementById('report-month-select');
        const reportTotalIncomeEl = document.getElementById('report-total-income');
        const reportTotalExpenseEl = document.getElementById('report-total-expense');
        const categoryExpenseChartEl = document.getElementById('category-expense-chart');
        const categoryExpenseListEl = document.getElementById('category-expense-list');
        const newCategoryInput = document.getElementById('new-category-input');
        const addCategoryBtn = document.getElementById('add-category-btn');
        const categoryListEl = document.getElementById('category-list');

        // User ID display element only
        const userIdDisplayEl = document.getElementById('user-id-display');

        // Elements for type selection buttons
        const expenseTypeBtn = document.getElementById('expense-type-btn');
        const incomeTypeBtn = document.getElementById('income-type-btn');
        const hiddenTransactionTypeInput = document.getElementById('transaction-type'); // Hidden input to store selected type

        // Elements for new category selection button
        const categorySelectButton = document.getElementById('category-select-button');
        const selectedCategoryText = document.getElementById('selected-category-text');
        const hiddenTransactionCategoryInput = document.getElementById('transaction-category'); // Hidden input to store selected category

        // Elements for new date selection button
        const dateSelectButton = document.getElementById('date-select-button');
        const selectedDateText = document.getElementById('selected-date-text');

        // Modal elements
        const customModal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');

        let confirmActionCallback = null; // To store the callback for confirmation

        // Function to show custom modal (replaces alert/confirm)
        function showCustomModal(title, message, onConfirm, onCancel = null) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            customModal.classList.remove('hidden');
            confirmActionCallback = onConfirm;

            modalConfirmBtn.onclick = () => {
                customModal.classList.add('hidden');
                if (confirmActionCallback) confirmActionCallback();
            };

            modalCancelBtn.onclick = () => {
                customModal.classList.add('hidden');
                if (onCancel) onCancel();
            };
        }

        // --- Utility Functions ---

        // Format currency (no "ကျပ်" suffix)
        function formatCurrency(amount) {
            return amount.toLocaleString();
        }

        // Get current date in YYYY-MM-DD format
        function getCurrentDate() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Get month name in Burmese
        function getMyanmarMonthName(monthIndex) {
            const months = [
                'ဇန်နဝါရီ', 'ဖေဖော်ဝါရီ', 'မတ်', 'ဧပြီ', 'မေ', 'ဇွန်',
                'ဇူလိုင်', 'သြဂုတ်', 'စက်တင်ဘာ', 'အောက်တိုဘာ', 'နိုဝင်ဘာ', 'ဒီဇင်ဘာ'
            ];
            return months[monthIndex];
        }

        // Format date for display on the button (e.g., "၇ ဇူလိုင် ၂၀၂၅")
        function formatDisplayDate(dateString) {
            if (!dateString) return 'ရက်စွဲ ရွေးချယ်ပါ';
            const date = new Date(dateString);
            const day = date.getDate();
            const month = getMyanmarMonthName(date.getMonth());
            const year = date.getFullYear();
            return `${day} ${month} ${year}`;
        }

        // Display user ID
        window.displayUserId = function() {
            if (userIdDisplayEl && currentUserId) {
                userIdDisplayEl.textContent = `User ID: ${currentUserId}`;
            } else if (userIdDisplayEl) {
                userIdDisplayEl.textContent = 'User ID: N/A (Authentication Pending)';
            }
        };

        // --- Firebase Initialization and Authentication ---

        // Initialize Firebase app and services using the provided firebaseConfig
        // This ensures the app connects to the correct Firebase project.
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // Listen for authentication state changes
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                isAuthReady = true;
                // Set up Firestore listeners only after authentication is ready
                setupFirestoreListeners();
                displayUserId(); // Update UI with user ID
            } else {
                // If no user is signed in, sign in anonymously to your Firebase project
                try {
                    await signInAnonymously(auth); 
                } catch (error) {
                    console.error("Error signing in anonymously:", error);
                    showCustomModal("Authentication Error", `Failed to sign in anonymously: ${error.message}`, () => {}, null);
                }
            }
        });

        // --- Firestore Data Listeners ---

        // Sets up real-time listeners for transactions and categories
        window.setupFirestoreListeners = function() {
            if (!db || !currentUserId || !isAuthReady) {
                console.log("Firestore or user not ready. Skipping listener setup.");
                return;
            }

            // Using secure, user-specific paths (UID based)
            const transactionsColRef = collection(db, `artifacts/${appId}/users/${currentUserId}/transactions`);
            const qTransactions = query(transactionsColRef, orderBy('timestamp', 'desc')); 

            onSnapshot(qTransactions, (snapshot) => {
                transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateTotalBalance();
                renderRecentTransactions();
                renderAllTransactions();
                populateFilterMonths();
                populateReportMonths();
                updateReports();
            }, (error) => {
                console.error("Error fetching transactions:", error);
                showCustomModal("Data Error", `Error loading transactions: ${error.message}`, () => {}, null);
            });

            // Using secure, user-specific paths (UID based)
            const categoriesColRef = collection(db, `artifacts/${appId}/users/${currentUserId}/categories`);
            const qCategories = query(categoriesColRef, orderBy('name')); 

            onSnapshot(qCategories, (snapshot) => {
                categories = snapshot.docs.map(doc => doc.data().name); 
                populateFilterCategories();
                renderCategoryList();
            }, (error) => {
                console.error("Error fetching categories:", error);
                showCustomModal("Data Error", `Error loading categories: ${error.message}`, () => {}, null);
            });
        };

        // --- UI Management ---

        // Show a specific screen and update navigation active state
        function showScreen(screenId) {
            screens.forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');

            navButtons.forEach(button => {
                if (button.dataset.screen === screenId) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });

            // Specific updates when screen changes
            if (screenId === 'dashboard-screen') {
                renderRecentTransactions();
            } else if (screenId === 'add-transaction-screen') {
                populateFilterCategories(); // Ensure categories are up-to-date for selection
                
                // Set default date and update button text
                const currentDate = getCurrentDate();
                hiddenTransactionDateInput.value = currentDate;
                selectedDateText.textContent = formatDisplayDate(currentDate);

                selectTransactionType('expense'); // Set default selected type to 'expense'

                // Update category selection display based on previously selected category
                if (selectedCategoryForForm) {
                    selectedCategoryText.textContent = selectedCategoryForForm;
                    selectedCategoryText.classList.remove('placeholder-text');
                    selectedCategoryText.classList.add('selected-text');
                    hiddenTransactionCategoryInput.value = selectedCategoryForForm;
                } else {
                    selectedCategoryText.textContent = 'အမျိုးအစား ရွေးချယ်ပါ';
                    selectedCategoryText.classList.add('placeholder-text');
                    selectedCategoryText.classList.remove('selected-text');
                    hiddenTransactionCategoryInput.value = ''; // Clear hidden input if no category selected
                }
            } else if (screenId === 'transactions-list-screen') {
                populateFilterMonths();
                populateFilterCategories();
                renderAllTransactions();
            } else if (screenId === 'reports-screen') {
                populateReportMonths();
                updateReports();
            } else if (screenId === 'categories-screen') {
                renderCategoryList();
            }
        }

        // Function to handle type button selection (Expense/Income)
        function selectTransactionType(type) {
            expenseTypeBtn.classList.remove('selected');
            incomeTypeBtn.classList.remove('selected');

            if (type === 'expense') {
                expenseTypeBtn.classList.add('selected');
            } else if (type === 'income') {
                incomeTypeBtn.classList.add('selected');
            }
            hiddenTransactionTypeInput.value = type;
        }

        // --- Core Functionality (Firestore Interactions) ---

        // Calculate and display total balance
        window.updateTotalBalance = function() {
            let totalIncome = 0;
            let totalExpense = 0;

            transactions.forEach(t => {
                if (t.type === 'income') {
                    totalIncome += t.amount;
                } else {
                    totalExpense += t.amount;
                }
            });

            const balance = totalIncome - totalExpense;
            totalBalanceEl.textContent = formatCurrency(balance);
            totalBalanceEl.classList.remove('text-green-600', 'text-red-600');
            if (balance > 0) {
                totalBalanceEl.classList.add('text-green-600');
            } else if (balance < 0) {
                totalBalanceEl.classList.add('text-red-600');
            }
        };

        // Add a new transaction to Firestore
        transactionForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!db || !currentUserId) {
                showCustomModal("အမှား", "အသုံးပြုသူ အတည်ပြုပြီးခြင်းမရှိပါ။", () => {}, null);
                return;
            }

            const type = hiddenTransactionTypeInput.value;
            const amount = parseFloat(transactionAmountEl.value);
            const category = hiddenTransactionCategoryInput.value;
            const date = hiddenTransactionDateInput.value;
            const description = transactionDescriptionEl.value.trim();

            if (isNaN(amount) || amount <= 0) {
                showCustomModal('အမှား', 'ပမာဏကို မှန်ကန်စွာ ထည့်သွင်းပါ။', () => {}, null);
                return;
            }
            if (!category) {
                showCustomModal('အမှား', 'အမျိုးအစားခွဲကို ရွေးချယ်ပါ။', () => {}, null);
                return;
            }
            if (!date) {
                showCustomModal('အမှား', 'ရက်စွဲကို ရွေးချယ်ပါ။', () => {}, null);
                return;
            }

            const newTransactionData = {
                type,
                amount,
                category,
                date,
                description,
                timestamp: new Date().toISOString() // For sorting/tracking
            };
            
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/transactions`), newTransactionData);
                transactionForm.reset(); // Clear form fields
                selectedCategoryForForm = ''; // Clear selected category for next transaction
                showScreen('dashboard-screen'); // Go back to dashboard after adding
            } catch (error) {
                console.error("Error adding transaction:", error);
                showCustomModal("ထည့်သွင်းမှုအမှား", `မှတ်တမ်းထည့်သွင်း၍ မရပါ။: ${error.message}`, () => {}, null);
            }
        });

        // Render recent transactions on dashboard
        window.renderRecentTransactions = function() {
            recentTransactionsEl.innerHTML = '';
            if (transactions.length === 0) {
                recentTransactionsEl.innerHTML = '<p class="text-gray-500 text-center mt-8">မှတ်တမ်းများ မရှိသေးပါ</p>';
                return;
            }

            // Display up to 5 most recent transactions
            transactions.slice(0, 5).forEach(t => {
                const transactionItem = document.createElement('div');
                transactionItem.classList.add('flex', 'justify-between', 'items-center', 'bg-white', 'p-4', 'rounded-xl', 'shadow-sm', 'border', 'border-gray-100');
                const amountClass = t.type === 'income' ? 'text-green-600' : 'text-red-600';
                const sign = t.type === 'income' ? '+' : '-';

                transactionItem.innerHTML = `
                    <div>
                        <div class="font-medium text-gray-800">${t.category}</div>
                        <div class="text-xs text-gray-500">${t.description || 'မရှိပါ'}</div>
                        <div class="text-xs text-gray-400">${t.date}</div>
                    </div>
                    <div class="font-semibold ${amountClass}">${sign} ${formatCurrency(t.amount)}</div>
                `;
                recentTransactionsEl.appendChild(transactionItem);
            });
        };

        // Render all transactions list, with filtering and grouping by date
        window.renderAllTransactions = function() {
            allTransactionsEl.innerHTML = '';
            let filteredTransactions = transactions;

            const selectedMonth = filterMonthEl.value;
            const selectedCategory = filterCategoryEl.value;

            // Apply month filter
            if (selectedMonth) {
                filteredTransactions = filteredTransactions.filter(t => {
                    const transactionDate = new Date(t.date);
                    const transactionMonth = transactionDate.getMonth();
                    const transactionYear = transactionDate.getFullYear();
                    const [filterYear, filterMonth] = selectedMonth.split('-').map(Number);
                    return transactionMonth === filterMonth && transactionYear === filterYear;
                });
            }

            // Apply category filter
            if (selectedCategory) {
                filteredTransactions = filteredTransactions.filter(t => t.category === selectedCategory);
            }

            if (filteredTransactions.length === 0) {
                allTransactionsEl.innerHTML = '<p class="text-gray-500 text-center mt-8">မှတ်တမ်းများ မရှိသေးပါ</p>';
                return;
            }

            // Group transactions by date
            const groupedTransactions = filteredTransactions.reduce((acc, t) => {
                const date = t.date;
                if (!acc[date]) {
                    acc[date] = [];
                }
                acc[date].push(t);
                return acc;
            }, {});

            // Sort dates in descending order (most recent first)
            const sortedDates = Object.keys(groupedTransactions).sort((a, b) => new Date(b) - new Date(a));

            sortedDates.forEach(date => {
                const dateHeader = document.createElement('div');
                dateHeader.classList.add('text-sm', 'font-semibold', 'text-gray-600', 'mt-4', 'mb-2', 'border-b', 'pb-1');
                dateHeader.textContent = formatDisplayDate(date); // Display formatted date
                allTransactionsEl.appendChild(dateHeader);

                // Sort transactions within each date by timestamp (most recent first)
                groupedTransactions[date].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                groupedTransactions[date].forEach(t => {
                    const transactionItem = document.createElement('div');
                    transactionItem.classList.add('flex', 'justify-between', 'items-center', 'bg-white', 'p-4', 'rounded-xl', 'shadow-sm', 'border', 'border-gray-100');
                    const amountClass = t.type === 'income' ? 'text-green-600' : 'text-red-600';
                    const sign = t.type === 'income' ? '+' : '-';

                    transactionItem.innerHTML = `
                        <div>
                            <div class="font-medium text-gray-800">${t.category}</div>
                            <div class="text-xs text-gray-500">${t.description || 'မရှိပါ'}</div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <div class="font-semibold ${amountClass}">${sign} ${formatCurrency(t.amount)}</div>
                            <button data-id="${t.id}" class="delete-transaction-btn text-red-500 hover:text-red-700 p-1 rounded-full">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.927a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m-1.022.165L5.67 19.673a2.25 2.25 0 002.244 2.077h8.927a2.25 2.25 0 002.244-2.077L19.5 5.79m-9.444.114c-.276-.053-.55-.108-.822-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.14-2.006-2.201C16.152 2.15 15.174 2.1 12 2.1c-3.174 0-4.152.05-4.444.093C6.106 2.45 5.25 3.42 5.25 4.5V5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m-1.022.165L5.67 19.673a2.25 2.25 0 002.244 2.077h8.927a2.25 2.25 0 002.244-2.077L19.5 5.79" />
                                </svg>
                            </button>
                        </div>
                    `;
                    allTransactionsEl.appendChild(transactionItem);
                });
            });

            // Add event listeners for delete buttons
            document.querySelectorAll('.delete-transaction-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const transactionId = e.currentTarget.dataset.id; // Get the ID from the button's data attribute
                    showCustomModal(
                        'ဖျက်မည်လား',
                        'ဤမှတ်တမ်းကို ဖျက်ရန် သေချာပါသလား။',
                        () => deleteTransaction(transactionId)
                    );
                });
            });
        };

        // Delete a transaction from Firestore
        async function deleteTransaction(id) {
            if (!db || !currentUserId) {
                showCustomModal("အမှား", "အသုံးပြုသူ အတည်ပြုပြီးခြင်းမရှိပါ။", () => {}, null);
                return;
            }
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/transactions`, id));
                // onSnapshot listener will automatically update the UI
            } catch (error) {
                console.error("Error deleting transaction:", error);
                showCustomModal("ဖျက်မှုအမှား", `မှတ်တမ်းကို ဖျက်၍မရပါ။: ${error.message}`, () => {}, null);
            }
        }

        // Populate category dropdowns (for filter and add transaction screen)
        window.populateFilterCategories = function() {
            const selectEl = filterCategoryEl;
            const currentSelected = selectEl.value; // Preserve current selection
            selectEl.innerHTML = '';
            const allOption = document.createElement('option');
            allOption.value = '';
            allOption.textContent = 'အမျိုးအစား အားလုံး';
            selectEl.appendChild(allOption);

            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                selectEl.appendChild(option);
            });
            selectEl.value = currentSelected; // Restore current selection
        };

        // Populate month filter dropdown based on existing transactions
        window.populateFilterMonths = function() {
            filterMonthEl.innerHTML = '<option value="">လ အားလုံး</option>';
            const monthsSet = new Set();
            transactions.forEach(t => {
                const date = new Date(t.date);
                const year = date.getFullYear();
                const month = date.getMonth();
                monthsSet.add(`${year}-${month}`); // Store as "YYYY-MM"
            });

            // Sort months in descending order (most recent first)
            const sortedMonths = Array.from(monthsSet).sort((a, b) => {
                const [yearA, monthA] = a.split('-').map(Number);
                const [yearB, monthB] = b.split('-').map(Number);
                if (yearA !== yearB) return yearB - yearA; // Sort by year
                return monthB - monthA; // Then by month
            });

            sortedMonths.forEach(monthKey => {
                const [year, monthIndex] = monthKey.split('-').map(Number);
                const option = document.createElement('option');
                option.value = monthKey;
                option.textContent = `${getMyanmarMonthName(monthIndex)} ${year}`;
                filterMonthEl.appendChild(option);
            });
        };

        // Populate report month select dropdown
        window.populateReportMonths = function() {
            reportMonthSelectEl.innerHTML = '';
            const monthsSet = new Set();
            transactions.forEach(t => {
                const date = new Date(t.date);
                const year = date.getFullYear();
                const month = date.getMonth();
                monthsSet.add(`${year}-${month}`);
            });

            const sortedMonths = Array.from(monthsSet).sort((a, b) => {
                const [yearA, monthA] = a.split('-').map(Number);
                const [yearB, monthB] = b.split('-').map(Number);
                if (yearA !== yearB) return yearB - yearA;
                return monthB - monthA;
            });

            // If no transactions exist, add current month as default for reports
            if (sortedMonths.length === 0) {
                const currentMonth = new Date();
                const currentYear = currentMonth.getFullYear();
                const currentMonthIndex = currentMonth.getMonth();
                const option = document.createElement('option');
                option.value = `${currentYear}-${currentMonthIndex}`;
                option.textContent = `${getMyanmarMonthName(currentMonthIndex)} ${currentYear}`;
                reportMonthSelectEl.appendChild(option);
            } else {
                sortedMonths.forEach(monthKey => {
                    const [year, monthIndex] = monthKey.split('-').map(Number);
                    const option = document.createElement('option');
                    option.value = monthKey;
                    option.textContent = `${getMyanmarMonthName(monthIndex)} ${year}`;
                    reportMonthSelectEl.appendChild(option);
                });
            }
        };

        // Update reports based on selected month
        window.updateReports = function() {
            const selectedMonthKey = reportMonthSelectEl.value;
            if (!selectedMonthKey) {
                reportTotalIncomeEl.textContent = formatCurrency(0);
                reportTotalExpenseEl.textContent = formatCurrency(0);
                categoryExpenseChartEl.innerHTML = '<p class="text-gray-500">အချက်အလက် မရှိသေးပါ</p>';
                categoryExpenseListEl.innerHTML = '';
                return;
            }

            const [selectedYear, selectedMonthIndex] = selectedMonthKey.split('-').map(Number);

            // Filter transactions for the selected month
            const monthlyTransactions = transactions.filter(t => {
                const date = new Date(t.date);
                return date.getFullYear() === selectedYear && date.getMonth() === selectedMonthIndex;
            });

            let totalIncome = 0;
            let totalExpense = 0;
            const categoryExpenses = {}; // To store expense breakdown by category

            monthlyTransactions.forEach(t => {
                if (t.type === 'income') {
                    totalIncome += t.amount;
                } else {
                    totalExpense += t.amount;
                    categoryExpenses[t.category] = (categoryExpenses[t.category] || 0) + t.amount;
                }
            });

            reportTotalIncomeEl.textContent = formatCurrency(totalIncome);
            reportTotalExpenseEl.textContent = formatCurrency(totalExpense);

            renderCategoryExpenseChart(categoryExpenses, totalExpense);
            renderCategoryExpenseList(categoryExpenses);
        };

        // Render category expense chart (simple bar chart representation)
        function renderCategoryExpenseChart(data, totalExpense) {
            categoryExpenseChartEl.innerHTML = '';
            if (Object.keys(data).length === 0 || totalExpense === 0) {
                categoryExpenseChartEl.innerHTML = '<p class="text-gray-500">အချက်အလက် မရှိသေးပါ</p>';
                return;
            }

            // Sort categories by expense amount in descending order
            const sortedCategories = Object.entries(data).sort(([, a], [, b]) => b - a);

            const chartContainer = document.createElement('div');
            chartContainer.classList.add('w-full', 'h-full', 'flex', 'flex-col', 'justify-end', 'p-2');

            sortedCategories.forEach(([category, amount]) => {
                const percentage = (amount / totalExpense) * 100;
                const bar = document.createElement('div');
                bar.classList.add('flex', 'items-center', 'mb-1');
                bar.innerHTML = `
                    <div class="text-xs text-gray-700 w-1/3 truncate">${category}</div>
                    <div class="flex-grow bg-gray-200 rounded-full h-2 mx-2 overflow-hidden">
                        <div class="bg-indigo-500 h-full rounded-full" style="width: ${percentage.toFixed(0)}%;"></div>
                    </div>
                    <div class="text-xs font-medium text-gray-700 w-1/6 text-right">${percentage.toFixed(0)}%</div>
                `;
                chartContainer.appendChild(bar);
            });
            categoryExpenseChartEl.appendChild(chartContainer);
        }

        // Render category expense list
        function renderCategoryExpenseList(data) {
            categoryExpenseListEl.innerHTML = '';
            if (Object.keys(data).length === 0) {
                return;
            }

            // Sort categories by expense amount in descending order
            const sortedCategories = Object.entries(data).sort(([, a], [, b]) => b - a);

            sortedCategories.forEach(([category, amount]) => {
                const listItem = document.createElement('div');
                listItem.classList.add('flex', 'justify-between', 'items-center', 'bg-white', 'p-3', 'rounded-xl', 'shadow-sm', 'border', 'border-gray-100');
                listItem.innerHTML = `
                    <div class="font-medium text-gray-800">${category}</div>
                    <div class="font-semibold text-red-600">${formatCurrency(amount)}</div>
                `;
                categoryExpenseListEl.appendChild(listItem);
            });
        }

        // Render category list for management screen
        window.renderCategoryList = function() {
            categoryListEl.innerHTML = '';
            if (categories.length === 0) {
                categoryListEl.innerHTML = '<p class="text-gray-500 text-center mt-8">အမျိုးအစားများ မရှိသေးပါ</p>';
                return;
            }
            categories.forEach(cat => {
                const categoryItem = document.createElement('div');
                categoryItem.classList.add('flex', 'justify-between', 'items-center', 'bg-white', 'p-4', 'rounded-xl', 'shadow-sm', 'border', 'border-gray-100', 'cursor-pointer');
                categoryItem.innerHTML = `
                    <span class="font-medium text-gray-800" data-category-name="${cat}">${cat}</span>
                    <button data-category="${cat}" class="delete-category-btn text-red-500 hover:text-red-700 p-1 rounded-full">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.927a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m-1.022.165L5.67 19.673a2.25 2.25 0 002.244 2.077h8.927a2.25 2.25 0 002.244-2.077L19.5 5.79m-9.444.114c-.276-.053-.55-.108-.822-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.14-2.006-2.201C16.152 2.15 15.174 2.1 12 2.1c-3.174 0-4.152.05-4.444.093C6.106 2.45 5.25 3.42 5.25 4.5V5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m-1.022.165L5.67 19.673a2.25 2.25 0 002.244 2.077h8.927a2.25 2.25 0 002.244-2.077L19.5 5.79" />
                        </svg>
                    </button>
                `;
                categoryListEl.appendChild(categoryItem);

                // Event listener to select a category when clicked (for add transaction screen)
                categoryItem.addEventListener('click', (e) => {
                    // Only trigger selection if not clicking the delete button
                    if (!e.target.closest('.delete-category-btn')) {
                        const categoryName = e.currentTarget.querySelector('span').dataset.categoryName;
                        selectedCategoryForForm = categoryName; // Store selected category
                        showScreen('add-transaction-screen'); // Navigate back to add transaction screen
                    }
                });
            });

            // Add event listeners for delete category buttons
            document.querySelectorAll('.delete-category-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const categoryToDelete = e.currentTarget.dataset.category;
                    showCustomModal(
                        'ဖျက်မည်လား',
                        `"${categoryToDelete}" အမျိုးအစားကို ဖျက်ရန် သေချာပါသလား။ ဤအမျိုးအစားဖြင့် မှတ်တမ်းတင်ထားသော အချက်အလက်များ ပြောင်းလဲမည် မဟုတ်ပါ။`,
                        () => deleteCategory(categoryToDelete)
                    );
                });
            });
        };

        // Add a new category to Firestore
        addCategoryBtn.addEventListener('click', async () => {
            if (!db || !currentUserId) {
                showCustomModal("အမှား", "အသုံးပြုသူ အတည်ပြုပြီးခြင်းမရှိပါ။", () => {}, null);
                return;
            }
            const newCat = newCategoryInput.value.trim();
            if (newCat) {
                // Check if category already exists locally (from Firestore snapshot)
                if (categories.includes(newCat)) {
                    showCustomModal('အမှား', 'ဤအမျိုးအစား ရှိပြီးသားဖြစ်ပါသည်။', () => {}, null);
                    return;
                }
                try {
                    await addDoc(collection(db, `artifacts/${appId}/users/${currentUserId}/categories`), { name: newCat });
                    newCategoryInput.value = ''; // Clear input field
                    // onSnapshot listener will automatically update the UI
                } catch (error) {
                    console.error("Error adding category:", error);
                    showCustomModal("ထည့်သွင်းမှုအမှား", `အမျိုးအစားထည့်သွင်း၍ မရပါ။: ${error.message}`, () => {}, null);
                }
            }
        });

        // Delete a category from Firestore
        async function deleteCategory(catToDelete) {
            if (!db || !currentUserId) {
                showCustomModal("အမှား", "အသုံးပြုသူ အတည်ပြုပြီးခြင်းမရှိပါ။", () => {}, null);
                return;
            }
            const categoriesColRef = collection(db, `artifacts/${appId}/users/${currentUserId}/categories`);
            const q = query(categoriesColRef, where('name', '==', catToDelete));
            try {
                const querySnapshot = await getDocs(q); // Get documents matching the query
                if (!querySnapshot.empty) {
                    const docToDelete = querySnapshot.docs[0]; // Get the first matching document
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${currentUserId}/categories`, docToDelete.id));
                    // onSnapshot listener will automatically update the UI
                } else {
                    showCustomModal('အမှား', 'ဖျက်ရန် အမျိုးအစားကို ရှာမတွေ့ပါ။', () => {}, null);
                }
            } catch (error) {
                console.error("Error deleting category:", error);
                showCustomModal("ဖျက်မှုအမှား", `အမျိုးအစားကို ဖျက်၍မရပါ။: ${error.message}`, () => {}, null);
            }
        }

        // --- Event Listeners ---

        // Navigation buttons to switch screens
        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                showScreen(button.dataset.screen);
            });
        });

        // Event listeners for the new type selection buttons (Expense/Income)
        expenseTypeBtn.addEventListener('click', () => selectTransactionType('expense'));
        incomeTypeBtn.addEventListener('click', () => selectTransactionType('income'));

        // Event listener for the new category selection button
        categorySelectButton.addEventListener('click', () => {
            showScreen('categories-screen');
        });

        // Event listener for the new date selection button to open native date picker
        dateSelectButton.addEventListener('click', () => {
            hiddenTransactionDateInput.showPicker();
        });

        // Event listener for when the hidden date input's value changes
        hiddenTransactionDateInput.addEventListener('change', () => {
            selectedDateText.textContent = formatDisplayDate(hiddenTransactionDateInput.value);
        });

        // Filter transactions when month or category filter changes
        filterMonthEl.addEventListener('change', renderAllTransactions);
        filterCategoryEl.addEventListener('change', renderAllTransactions);

        // Update reports when report month selection changes
        reportMonthSelectEl.addEventListener('change', updateReports);

        // Initial setup when the page loads
        window.onload = function() {
            // Firebase authentication listener will handle calling setupFirestoreListeners
            // This ensures Firebase is initialized and user is authenticated before data operations
            showScreen('dashboard-screen'); // Show dashboard as the default screen on load
            displayUserId(); // Initial display, will be updated once auth is ready
        };
    </script>
</body>
</html>

