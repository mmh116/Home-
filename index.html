<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>အိမ်သုံးစရိတ်မှတ်တမ်း</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: contain; /* Prevent pull-to-refresh on mobile */
        }
        /* Custom CSS for scrollbars */
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }

        /* Keyframe animation for fade-in-out effect */
        @keyframes fade-in-out { 0% { opacity: 0; transform: translateY(10px); } 10% { opacity: 1; transform: translateY(0); } 90% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(0); } }
        .animate-fade-in-out { animation: fade-in-out 2s ease-in-out forwards; }

        /* Keyframe animation for spinning loader */
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }

        /* Style for input type="date" to match other inputs and allow clickability */
        input[type="date"]::-webkit-calendar-picker-indicator {
            color: rgba(0, 0, 0, 0);
            opacity: 0;
            display: block;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            cursor: pointer;
        }
        input[type="date"] {
            -webkit-appearance: none;
            appearance: none;
            position: relative;
        }

        /* Styling for month input */
        input[type="month"]::-webkit-calendar-picker-indicator {
            background: none;
            opacity: 0;
            cursor: pointer;
            width: 100%;
            height: 100%;
        }
        input[type="month"] {
            -webkit-appearance: none;
            appearance: none;
            position: relative;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="root"></div>

    <!-- React and ReactDOM CDNs -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babel for JSX transformation in browser -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs CDNs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, setDoc, deleteDoc, doc, getDoc, getDocs, updateDoc, where } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";

        // Expose Firebase functions and objects globally for the Babel script
        window.firebase = {
            initializeApp,
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, collection, query, onSnapshot, addDoc, setDoc, deleteDoc, doc, getDoc, getDocs, updateDoc, where
        };

        // >>> START: REPLACE WITH YOUR ACTUAL FIREBASE CONFIG <<<
        // IMPORTANT: Replace the entire block below (including the 'const firebaseConfig = { ... };' line and subsequent window assignments)
        // with the "Config" snippet you obtain from your Firebase Project Settings -> Your web app.
        // It should look similar to the commented-out example below, but with your unique values.
        /*
        const firebaseConfig = {
          apiKey: "YOUR_ACTUAL_API_KEY",
          authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
          projectId: "YOUR_PROJECT_ID",
          storageBucket: "YOUR_PROJECT_ID.appspot.com",
          messagingSenderId: "YOUR_SENDER_ID",
          appId: "YOUR_APP_ID",
          measurementId: "YOUR_MEASUREMENT_ID"
        };
        */
        const firebaseConfig = {
          apiKey: "AIzaSyDUf0QF4GqMb6s9ODTUiX7aTHRTR0YUqcE", // REPLACE THIS VALUE
          authDomain: "html-3ce83.firebaseapp.com", // REPLACE THIS VALUE
          databaseURL: "https://html-3ce83-default-rtdb.asia-southeast1.firebasedatabase.app", // REPLACE THIS VALUE (if provided in your Firebase config)
          projectId: "html-3ce83", // REPLACE THIS VALUE
          storageBucket: "html-3ce83.firebasestorage.app", // REPLACE THIS VALUE
          messagingSenderId: "602585837585", // REPLACE THIS VALUE
          appId: "1:602585837585:web:415bd8bcc59b4cbd4d81b0", // REPLACE THIS VALUE
          measurementId: "G-QBME7CRR2X" // REPLACE THIS VALUE (if provided in your Firebase config)
        };
        // Do NOT modify these lines. They correctly use the firebaseConfig object.
        window.__app_id = firebaseConfig.appId;
        window.__firebase_config = JSON.stringify(firebaseConfig);
        window.__initial_auth_token = typeof __initial_auth_token !== 'undefined' ? window.__initial_auth_token : '';
        // >>> END: REPLACE WITH YOUR ACTUAL FIREBASE CONFIG <<<
    </script>

    <!-- Your React Component -->
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // Helper function to format date to WHICH-MM-DD
        const formatDate = (date) => {
          const d = new Date(date);
          const year = d.getFullYear();
          const month = String(d.getMonth() + 1).padStart(2, '0');
          const day = String(d.getDate()).padStart(2, '0');
          return `${year}-${month}-${day}`;
        };

        // Helper function to format month to WHICH-MM
        const formatMonthYear = (date) => {
          const d = new Date(date);
          const year = d.getFullYear();
          const month = String(d.getMonth() + 1).padStart(2, '0');
          return `${year}-${month}`;
        };

        // Re-mapping Lucide React icons to simple inline SVGs
        const ChevronLeft = ({ size = 20, className = '' }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m15 18-6-6 6-6"/></svg>;
        const ChevronRight = ({ size = 20, className = '' }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m9 18 6-6-6-6"/></svg>;
        const Plus = ({ size = 28, className = '' }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 5v14M5 12h14"/></svg>;
        const Copy = ({ size = 16, className = '' }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></svg>;
        const Edit = ({ size = 18, className = '' }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4Z"/></svg>;
        const Trash2 = ({ size = 18, className = '' }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>;
        const CalendarDays = ({ size = 16, className = '' }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="M8 14h.01"/><path d="M12 14h.01"/><path d="M16 14h.01"/><path d="M8 18h.01"/><path d="M12 18h.01"/><path d="M16 18h.01"/></svg>;
        const X = ({ size = 24, className = '' }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>;
        const User = ({ size = 18, className = '' }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg>;
        const Loader2 = ({ size = 48, className = '' }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>;
        const Tag = ({ size = 18, className = '' }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414L15.172 22.172a4 4 0 0 0 5.656 0l3.828-3.828a4 4 0 0 0 0-5.656L12.586 2.586Z"/><path d="M7.5 7.5h.01"/></svg>;
        const Info = ({ size = 18, className = '' }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>;
        const TrendingUp = ({ size = 18, className = '' }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>;
        const TrendingDown = ({ size = 18, className = '' }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="22 17 13.5 8.5 8.5 13.5 2 7"/><polyline points="16 17 22 17 22 11"/></svg>;


        // Main App Component
        const App = () => {
          // --- Debugging State ---
          const [debugMessages, setDebugMessages] = useState([]);
          const debugLogRef = useRef(null); // Ref for scrolling to bottom of log

          const addDebugMessage = useCallback((message, type = 'info') => {
            const timestamp = new Date().toLocaleTimeString('en-US', { hour12: false });
            setDebugMessages(prevMessages => [...prevMessages, { timestamp, message, type }]);
            // Scroll to bottom when new message added
            // Using a timeout to ensure DOM update before scrolling
            if (debugLogRef.current) {
                setTimeout(() => {
                    debugLogRef.current.scrollTop = debugLogRef.current.scrollHeight;
                }, 10);
            }
          }, []);

          // --- Firebase States ---
          const [db, setDb] = useState(null);
          const [auth, setAuth] = useState(null);
          const [userId, setUserId] = useState(null); // Firebase Auth UID
          const [isLoading, setIsLoading] = useState(true); // Initial loading state for Firebase init and data fetch

          // --- Data Identifier State (for persistence across sessions) ---
          const [dataIdentifier, setDataIdentifier] = useState(''); // Initialized to empty, will load from localStorage in useEffect
          const [dataIdentifierInput, setDataIdentifierInput] = useState(''); // Input field state for data identifier
          const [idErrorMessage, setIdErrorMessage] = useState(''); // Error message for data identifier input
          const [showDataIdentifierModal, setShowDataIdentifierModal] = useState(false); // New state for modal visibility
          const [dataIdentifierSaveSuccess, setDataIdentifierSaveSuccess] = useState(false); // New state for save confirmation message

          // --- Expense Management States ---
          const [currentDate, setCurrentDate] = useState(formatDate(new Date()));
          const [expenses, setExpenses] = useState([]); // All expenses for the CURRENTLY selected day
          const [expenseDescription, setExpenseDescription] = useState('');
          const [expenseAmount, setExpenseAmount] = useState('');
          const [expenseCategory, setExpenseCategory] = useState(''); // Selected category for new/edited expense
          const [editingExpenseId, setEditingExpenseId] = useState(null); // ID of expense being edited

          // --- Income Management States ---
          const [incomes, setIncomes] = useState([]); // All incomes for the CURRENTLY selected day
          const [incomeDescription, setIncomeDescription] = useState('');
          const [incomeAmount, setIncomeAmount] = useState('');
          const [showAddIncomeModal, setShowAddIncomeModal] = useState(false); // Controls add income modal visibility
          const [showConfirmDeleteIncomeModal, setShowConfirmDeleteIncomeModal] = useState(false); // NEW: Controls income deletion confirmation modal
          const [incomeToDeleteId, setIncomeToDeleteId] = useState(null); // NEW: ID of income to be deleted


          // --- Categories Management States ---
          const [categories, setCategories] = useState([]); // Master list of expense categories
          const [newCategoryName, setNewCategoryName] = useState(''); // Input for adding/editing category
          const [editingCategoryId, setEditingCategoryId] = useState(null); // ID of category being edited
          const [showManageCategoriesModal, setShowManageCategoriesModal] = useState(false); // Controls category management modal visibility
          const [confirmDeleteCategoryModal, setConfirmDeleteCategoryModal] = useState(false); // Controls category deletion confirmation
          const [categoryToDeleteId, setCategoryToDeleteId] = useState(null); // ID of category to delete

          // --- UI/Modal Control States ---
          const [errorMessage, setErrorMessage] = useState(''); // Global error message (for expense/category adds/updates)
          const [showDatePicker, setShowDatePicker] = useState(false); // Controls date picker visibility
          const [showConfirmDeleteExpenseModal, setShowConfirmDeleteExpenseModal] = useState(false); // Renamed: for expense deletion confirmation modal
          const [expenseToDeleteId, setExpenseToDeleteId] = useState(null); // ID of expense to be deleted
          const [showCopyConfirmation, setShowCopyConfirmation] = useState(false); // Controls copy confirmation message visibility
          const [showMonthlySummaryModal, setShowMonthlySummaryModal] = useState(false); // Controls monthly summary modal visibility
          const [currentMonth, setCurrentMonth] = useState(formatMonthYear(new Date())); // Selected month for monthly summaries
          const [monthlyTotalExpenses, setMonthlyTotalExpenses] = useState(0); // Total for monthly summary expenses
          const [monthlyTotalIncomes, setMonthlyTotalIncomes] = useState(0); // Total for monthly summary incomes
          const [isMonthlySummaryLoading, setIsMonthlySummaryLoading] = useState(false); // Loading state for monthly summary

          // --- Refs for UI elements ---
          const fixedInputAreaRef = useRef(null); // Ref for the fixed bottom input area
          const [fixedInputAreaHeight, setFixedInputAreaHeight] = useState(0); // Height of the fixed input area for dynamic padding

          // Calculate the height of the fixed input area for dynamic padding
          useEffect(() => {
            if (fixedInputAreaRef.current) {
              setFixedInputAreaHeight(fixedInputAreaRef.current.offsetHeight);
            }
          }, [fixedInputAreaRef.current]); // Recalculate if ref changes

          // --- Firebase Initialization and Authentication ---
          useEffect(() => {
            // Retrieve Firebase Config from window.__firebase_config
            const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id'; // Fallback appId if not set
            const firebaseConfig = typeof window.__firebase_config !== 'undefined' ? JSON.parse(window.__firebase_config) : {};
            const initialAuthToken = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : '';

            addDebugMessage("Firebase Init: Starting...", "info");
            if (!firebaseConfig || Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey) {
              addDebugMessage("Firebase config is missing or incomplete. Data persistence will not work. Please ensure your Firebase config is correctly pasted.", "error");
              setErrorMessage("Firebase Config ကို ထည့်သွင်းရန် လိုအပ်ပါသည်။ သို့မဟုတ် Config မှားယွင်းနေပါသည်။"); // User-friendly error message
              setIsLoading(false);
              return;
            }

            try {
                const app = window.firebase.initializeApp(firebaseConfig);
                const database = window.firebase.getFirestore(app);
                const authInstance = window.firebase.getAuth(app);
                setDb(database);
                setAuth(authInstance);

                const unsubscribeAuth = window.firebase.onAuthStateChanged(authInstance, async (user) => {
                  if (user) {
                    setUserId(user.uid);
                    addDebugMessage(`Firebase Auth State Changed: Logged in as ${user.uid}`, "success");
                  } else {
                    addDebugMessage("Firebase Auth State Changed: No user, attempting anonymous sign-in or custom token.", "info");
                    try {
                      if (initialAuthToken) {
                        await window.firebase.signInWithCustomToken(authInstance, initialAuthToken);
                        addDebugMessage("Signed in with custom token.", "success");
                      } else {
                        await window.firebase.signInAnonymously(authInstance);
                        addDebugMessage("Signed in anonymously.", "success");
                      }
                    } catch (error) {
                      addDebugMessage(`Firebase Auth Error: ${error.message || error.code}. Check Firebase Authorized Domains.`, "error");
                      setErrorMessage(`Authentication failed. (${error.message || error.code}). Firebase Authorized Domains ကို စစ်ဆေးပါ။`);
                    }
                  }
                  setIsLoading(false); // Auth is ready, stop initial loading indicator
                  addDebugMessage("Firebase Auth State: Loading complete.", "info");
                });

                return () => unsubscribeAuth(); // Cleanup auth listener on component unmount
            } catch (e) {
                addDebugMessage(`Firebase Initialization Failed: ${e.message || e.code}. Check Firebase Config and Authorized Domains.`, "error");
                setErrorMessage(`Firebase စတင်ရာတွင် အမှားအယွင်းရှိခဲ့ပါသည်။ (${e.message || e.code}). Firebase Config နှင့် Authorized Domains ကို စစ်ဆေးပါ။`);
                setIsLoading(false);
            }
          }, [addDebugMessage]); // Dependency on addDebugMessage

          // --- Effect for initial load of dataIdentifier from localStorage ---
          useEffect(() => {
              addDebugMessage("Attempting to load dataIdentifier from localStorage.", "info");
              try {
                  const savedId = localStorage.getItem('household_expense_data_identifier');
                  if (savedId) {
                      setDataIdentifier(savedId);
                      setDataIdentifierInput(savedId); // Ensure input field reflects saved ID
                      addDebugMessage(`Loaded dataIdentifier from localStorage: ${savedId}`, "info");
                  } else {
                      addDebugMessage("No dataIdentifier found in localStorage on initial load.", "info");
                      // Immediately show modal if no dataIdentifier is found
                      setShowDataIdentifierModal(true);
                      setIdErrorMessage("User ID မရှိသေးပါ။ ကျေးဇူးပြု၍ ID အသစ်တစ်ခု ထည့်သွင်းပါ။");
                  }
              } catch (e) {
                  addDebugMessage(`Error reading initial dataIdentifier from localStorage: ${e.message || e.code}`, "error");
                  // Not setting user-visible error here as localStorage errors are common in sandboxed environments
              }
          }, [addDebugMessage]); // Empty dependency array means this runs once on component mount

          // --- Effect to manage dataIdentifier persistence in localStorage ---
          useEffect(() => {
              addDebugMessage(`dataIdentifier changed, attempting to save to localStorage: ${dataIdentifier}`, "info");
              try {
                  if (dataIdentifier) {
                      localStorage.setItem('household_expense_data_identifier', dataIdentifier);
                      addDebugMessage(`Successfully saved dataIdentifier to localStorage: ${dataIdentifier}`, "success");
                  } else {
                      // Only remove if it was previously set, to avoid unnecessary operations
                      if (localStorage.getItem('household_expense_data_identifier')) {
                           localStorage.removeItem('household_expense_data_identifier');
                           addDebugMessage("Successfully removed dataIdentifier from localStorage (was empty).", "info");
                      }
                  }
              } catch (e) {
                  addDebugMessage(`Error accessing localStorage for dataIdentifier persistence: ${e.message || e.code}`, "error");
                  setErrorMessage(`User ID သိမ်းဆည်းရာတွင် အမှားအယွင်းရှိခဲ့ပါသည်။ (${e.message || e.code})`);
              }
          }, [dataIdentifier, addDebugMessage]);

          // --- Firestore Data Fetching (Expenses, Incomes & Categories) ---
          useEffect(() => {
            if (!db || !dataIdentifier) { // Depend on dataIdentifier
              addDebugMessage(`Skipping Firestore fetch: db or dataIdentifier not ready. dataIdentifier: ${dataIdentifier}`, "info");
              setExpenses([]); // Clear expenses if dataIdentifier is not set
              setIncomes([]); // Clear incomes as well
              setCategories([]); // Clear categories as well
              return;
            }

            const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
            addDebugMessage(`Firestore Fetch: Starting for dataIdentifier: ${dataIdentifier}, currentDate: ${currentDate}`, "info");

            // 1. Fetch Expenses for the current date
            const expensesCollectionRef = window.firebase.collection(db, `artifacts/${appId}/data_by_identifier/${dataIdentifier}/expenses`);
            const qExpenses = window.firebase.query(
              expensesCollectionRef,
              window.firebase.where('date', '==', currentDate)
            );

            const unsubscribeExpenses = window.firebase.onSnapshot(qExpenses, (snapshot) => {
              const fetchedExpenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              setExpenses(fetchedExpenses.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0))); // Sort by createdAt descending
              addDebugMessage(`Fetched ${fetchedExpenses.length} expenses for ${currentDate} under ID: ${dataIdentifier}.`, "info");
            }, (error) => {
              addDebugMessage(`Error fetching expenses: ${error.message || error.code}`, "error");
              setErrorMessage(`အသုံးစရိတ်များ တင်ရာတွင် အမှားအယွင်းရှိခဲ့ပါသည်။ (${error.message || error.code})`);
            });

            // 2. Fetch Incomes for the current date
            const incomesCollectionRef = window.firebase.collection(db, `artifacts/${appId}/data_by_identifier/${dataIdentifier}/incomes`);
            const qIncomes = window.firebase.query(
              incomesCollectionRef,
              window.firebase.where('date', '==', currentDate)
            );

            const unsubscribeIncomes = window.firebase.onSnapshot(qIncomes, (snapshot) => {
              const fetchedIncomes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
              setIncomes(fetchedIncomes.sort((a, b) => (b.createdAt?.toDate() || 0) - (a.createdAt?.toDate() || 0))); // Sort by createdAt descending
              addDebugMessage(`Fetched ${fetchedIncomes.length} incomes for ${currentDate} under ID: ${dataIdentifier}.`, "info");
            }, (error) => {
              addDebugMessage(`Error fetching incomes: ${error.message || error.code}`, "error");
              setErrorMessage(`ဝင်ငွေများ တင်ရာတွင် အမှားအယွင်းရှိခဲ့ပါသည်။ (${error.message || error.code})`);
            });


            // 3. Fetch Master Category List
            const categoriesCollectionRef = window.firebase.collection(db, `artifacts/${appId}/data_by_identifier/${dataIdentifier}/categories`);
            const qCategories = window.firebase.query(categoriesCollectionRef);
            const unsubscribeCategories = window.firebase.onSnapshot(qCategories, (snapshot) => {
                const fetchedCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setCategories(fetchedCategories.sort((a, b) => a.name.localeCompare(b.name))); // Sort categories alphabetically by name
                addDebugMessage(`Fetched ${fetchedCategories.length} master categories under ID: ${dataIdentifier}.`, "info");
            }, (error) => {
                addDebugMessage(`Error fetching master categories: ${error.message || error.code}`, "error");
                setErrorMessage(`အမျိုးအစားစာရင်း တင်ရာတွင် အမှားအယွင်းရှိခဲ့ပါသည်။ (${error.message || error.code})`);
            });

            return () => {
              unsubscribeExpenses();
              unsubscribeIncomes(); // Unsubscribe income listener
              unsubscribeCategories();
              addDebugMessage(`Firestore Listeners Unsubscribed for dataIdentifier: ${dataIdentifier}, currentDate: ${currentDate}`, "info");
            };
          }, [db, dataIdentifier, currentDate, addDebugMessage]);

          // --- Helper to calculate daily total expenses and incomes ---
          const dailyTotalExpenses = expenses.reduce((sum, expense) => sum + parseFloat(expense.amount || 0), 0);
          const dailyTotalIncomes = incomes.reduce((sum, income) => sum + parseFloat(income.amount || 0), 0);
          const dailyBalance = dailyTotalIncomes - dailyTotalExpenses; // NEW


          // --- Add/Update Expense Function ---
          const handleAddOrUpdateExpense = async () => {
            addDebugMessage("handleAddOrUpdateExpense called.", "action");
            if (!db || !dataIdentifier) {
              setErrorMessage("User ID မရှိသေးပါ။ ကျေးဇူးပြု၍ User ID ထည့်သွင်းပါ။");
              addDebugMessage("Validation Error: DB or dataIdentifier not available for expense operation.", "warning");
              return;
            }
            if (!expenseDescription.trim() || !expenseAmount || isNaN(parseFloat(expenseAmount))) {
              setErrorMessage("ဖော်ပြချက်နှင့် ပမာဏ ထည့်ရန် လိုအပ်ပါသည်။");
              addDebugMessage("Validation Error: Expense description or amount is invalid.", "warning");
              return;
            }
            if (!expenseCategory.trim()) {
                setErrorMessage("အမျိုးအစား ရွေးချယ်ရန် လိုအပ်ပါသည်။");
                addDebugMessage("Validation Error: Expense category is empty.", "warning");
                return;
            }

            setErrorMessage(''); // Clear previous error

            const expenseData = {
              date: currentDate,
              description: expenseDescription.trim(),
              amount: parseFloat(expenseAmount),
              category: expenseCategory.trim(),
              createdAt: editingExpenseId ? expenses.find(exp => exp.id === editingExpenseId)?.createdAt : new Date(), // Preserve original createdAt if editing
            };

            const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
            const expensesCollectionRef = window.firebase.collection(db, `artifacts/${appId}/data_by_identifier/${dataIdentifier}/expenses`);

            try {
              if (editingExpenseId) {
                addDebugMessage(`Attempting to update expense with ID: ${editingExpenseId}, data: ${JSON.stringify(expenseData)}`, "info");
                await window.firebase.updateDoc(window.firebase.doc(expensesCollectionRef, editingExpenseId), expenseData);
                setErrorMessage("အသုံးစရိတ်ကို အောင်မြင်စွာ ပြင်ဆင်ပြီးပါပြီ။");
                addDebugMessage("Expense updated successfully.", "success");
              } else {
                addDebugMessage(`Attempting to add new expense with data: ${JSON.stringify(expenseData)}`, "info");
                await window.firebase.addDoc(expensesCollectionRef, expenseData);
                setErrorMessage("အသုံးစရိတ်ကို အောင်မြင်စွာ ထည့်သွင်းပြီးပါပြီ။");
                addDebugMessage("Expense added successfully.", "success");
              }
              // Clear inputs after successful operation
              setExpenseDescription('');
              setExpenseAmount('');
              setExpenseCategory('');
              setEditingExpenseId(null);
              setTimeout(() => setErrorMessage(''), 3000);
            } catch (e) {
              addDebugMessage(`Error adding/updating expense: ${e.message || e.code}`, "error");
              setErrorMessage(`အသုံးစရိတ် ထည့်/ပြင်ဆင်ရာတွင် အမှားအယွင်းရှိခဲ့ပါသည်။ (${e.message || e.code})`);
            }
          };

          // --- Add Income Function ---
          const handleAddIncome = async () => {
              addDebugMessage("handleAddIncome called.", "action");
              if (!db || !dataIdentifier) {
                  setErrorMessage("User ID မရှိသေးပါ။ ကျေးဇူးပြု၍ User ID ထည့်သွင်းပါ။");
                  addDebugMessage("Validation Error: DB or dataIdentifier not available for income operation.", "warning");
                  return;
              }
              if (!incomeDescription.trim() || !incomeAmount || isNaN(parseFloat(incomeAmount))) {
                  setErrorMessage("ဝင်ငွေ ဖော်ပြချက်နှင့် ပမာဏ ထည့်ရန် လိုအပ်ပါသည်။");
                  addDebugMessage("Validation Error: Income description or amount is invalid.", "warning");
                  return;
              }

              setErrorMessage(''); // Clear previous error

              const incomeData = {
                  date: currentDate,
                  description: incomeDescription.trim(),
                  amount: parseFloat(incomeAmount),
                  createdAt: new Date(),
              };

              const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
              const incomesCollectionRef = window.firebase.collection(db, `artifacts/${appId}/data_by_identifier/${dataIdentifier}/incomes`);

              try {
                  addDebugMessage(`Attempting to add new income with data: ${JSON.stringify(incomeData)}`, "info");
                  await window.firebase.addDoc(incomesCollectionRef, incomeData);
                  setErrorMessage("ဝင်ငွေကို အောင်မြင်စွာ ထည့်သွင်းပြီးပါပြီ။");
                  addDebugMessage("Income added successfully.", "success");
                  // Clear inputs and close modal
                  setIncomeDescription('');
                  setIncomeAmount('');
                  setShowAddIncomeModal(false);
                  setTimeout(() => setErrorMessage(''), 3000);
              } catch (e) {
                  addDebugMessage(`Error adding income: ${e.message || e.code}`, "error");
                  setErrorMessage(`ဝင်ငွေ ထည့်ရာတွင် အမှားအယွင်းရှိခဲ့ပါသည်။ (${e.message || e.code})`);
              }
          };


          // --- Populate input fields for editing an existing expense ---
          const handleEditExpense = (expense) => {
            addDebugMessage(`Editing expense: ${expense.id}`, "action");
            setExpenseDescription(expense.description);
            setExpenseAmount(expense.amount.toString());
            setExpenseCategory(expense.category);
            setEditingExpenseId(expense.id);
            setErrorMessage("အသုံးစရိတ်ကို ပြင်ဆင်ရန် အောက်ပါ Input တွင် ပြင်ဆင်ပြီး '+' ခလုတ်ကိုနှိပ်၍ ပြန်လည် ထည့်သွင်းပါ။");
          };

          // --- Show custom delete confirmation modal for an expense ---
          const confirmDeleteExpense = (id) => {
            addDebugMessage(`Confirming delete for expense: ${id}`, "action");
            setExpenseToDeleteId(id);
            setShowConfirmDeleteExpenseModal(true);
          };

          // --- Execute deletion of an expense from Firestore ---
          const executeDeleteExpense = async () => {
            addDebugMessage(`Executing delete for expense: ${expenseToDeleteId}`, "action");
            if (!db || !dataIdentifier || !expenseToDeleteId) {
              setErrorMessage("User ID မရှိသေးပါ။ သို့မဟုတ် Database မရပါ။");
              addDebugMessage("Validation Error: DB, dataIdentifier or expenseToDeleteId not available for expense deletion.", "warning");
              return;
            }
            try {
              const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
              await window.firebase.deleteDoc(window.firebase.doc(db, `artifacts/${appId}/data_by_identifier/${dataIdentifier}/expenses`, expenseToDeleteId));
              setErrorMessage("အသုံးစရိတ်ကို ဖျက်ပြီးပါပြီ။");
              addDebugMessage(`Expense deleted successfully: ${expenseToDeleteId}`, "success");
              setShowConfirmDeleteExpenseModal(false);
              setExpenseToDeleteId(null);
              setEditingExpenseId(null); // Clear editing state if the item being edited is deleted
              setExpenseDescription(''); // Clear inputs
              setExpenseAmount('');
              setExpenseCategory('');
              setTimeout(() => setErrorMessage(''), 3000);
            } catch (e) {
              addDebugMessage(`Error deleting expense: ${e.message || e.code}`, "error");
              setErrorMessage(`အသုံးစရိတ် ဖျက်ရာတွင် အမှားအယွင်းရှိခဲ့ပါသည်။ (${e.message || e.code})`);
            }
          };

          // NEW: Show custom delete confirmation modal for an income
          const confirmDeleteIncome = (id) => {
            addDebugMessage(`Confirming delete for income: ${id}`, "action");
            setIncomeToDeleteId(id);
            setShowConfirmDeleteIncomeModal(true);
          };

          // NEW: Execute deletion of an income from Firestore
          const executeDeleteIncome = async () => {
            addDebugMessage(`Executing delete for income: ${incomeToDeleteId}`, "action");
            if (!db || !dataIdentifier || !incomeToDeleteId) {
              setErrorMessage("User ID မရှိသေးပါ။ သို့မဟုတ် Database မရပါ။");
              addDebugMessage("Validation Error: DB, dataIdentifier or incomeToDeleteId not available for income deletion.", "warning");
              return;
            }
            try {
              const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
              await window.firebase.deleteDoc(window.firebase.doc(db, `artifacts/${appId}/data_by_identifier/${dataIdentifier}/incomes`, incomeToDeleteId));
              setErrorMessage("ဝင်ငွေကို ဖျက်ပြီးပါပြီ။");
              addDebugMessage(`Income deleted successfully: ${incomeToDeleteId}`, "success");
              setShowConfirmDeleteIncomeModal(false);
              setIncomeToDeleteId(null);
              setTimeout(() => setErrorMessage(''), 3000);
            } catch (e) {
              addDebugMessage(`Error deleting income: ${e.message || e.code}`, "error");
              setErrorMessage(`ဝင်ငွေ ဖျက်ရာတွင် အမှားအယွင်းရှိခဲ့ပါသည်။ (${e.message || e.code})`);
            }
          };

          // --- Handle date navigation (previous/next day) ---
          const handleDateChange = (days) => {
            addDebugMessage(`Changing date by ${days} days. Current date: ${currentDate}`, "action");
            const newDate = new Date(currentDate);
            newDate.setDate(newDate.getDate() + days);
            setCurrentDate(formatDate(newDate));
            addDebugMessage(`New date: ${formatDate(newDate)}`, "info");
          };

          // --- Handle manual date selection from date picker ---
          const handleManualDateChange = (e) => {
            addDebugMessage(`Manual date change to: ${e.target.value}`, "action");
            setCurrentDate(e.target.value);
            setShowDatePicker(false);
          };

          // --- Category Management Functions ---
          const handleAddOrUpdateCategory = async () => {
            addDebugMessage("handleAddOrUpdateCategory called.", "action");
            addDebugMessage(`Current dataIdentifier for category operation: ${dataIdentifier}`, "info");
            addDebugMessage(`Current newCategoryName input: ${newCategoryName}`, "info");

            if (!db || !dataIdentifier) {
              setErrorMessage("User ID မရှိသေးပါ။ ကျေးဇူးပြု၍ User ID ထည့်သွင်းပါ။");
              addDebugMessage("Validation Error: DB or dataIdentifier not available for category operation.", "warning");
              return;
            }
            if (!newCategoryName.trim()) {
              setErrorMessage("အမျိုးအစားနာမည် ထည့်ရန် လိုအပ်ပါသည်။");
              addDebugMessage("Validation Error: Category name is empty.", "warning");
              return;
            }

            setErrorMessage(''); // Clear previous error

            const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
            const categoriesCollectionRef = window.firebase.collection(db, `artifacts/${appId}/data_by_identifier/${dataIdentifier}/categories`);

            try {
              if (editingCategoryId) {
                addDebugMessage(`Attempting to update category with ID: ${editingCategoryId}, name: ${newCategoryName.trim()}`, "info");
                await window.firebase.updateDoc(window.firebase.doc(categoriesCollectionRef, editingCategoryId), { name: newCategoryName.trim() });
                setErrorMessage("အမျိုးအစားကို အောင်မြင်စွာ ပြင်ဆင်ပြီးပါပြီ။");
                addDebugMessage("Category updated successfully.", "success");
              } else {
                addDebugMessage(`Checking for duplicate category name: ${newCategoryName.trim()}`, "info");
                const q = window.firebase.query(categoriesCollectionRef, window.firebase.where("name", "==", newCategoryName.trim()));
                const querySnapshot = await window.firebase.getDocs(q);
                if (!querySnapshot.empty) {
                  setErrorMessage("ဤအမျိုးအစားနာမည် ရှိပြီးသား ဖြစ်ပါသည်။");
                  addDebugMessage(`Duplicate category name found: ${newCategoryName.trim()}`, "warning");
                  return;
                }
                addDebugMessage(`Attempting to add new category: ${newCategoryName.trim()}`, "info");
                await window.firebase.addDoc(categoriesCollectionRef, { name: newCategoryName.trim(), createdAt: new Date() });
                setErrorMessage("အမျိုးအစားကို အောင်မြင်စွာ ထည့်သွင်းပြီးပါပြီ။");
                addDebugMessage("Category added successfully.", "success");
              }
              setNewCategoryName('');
              setEditingCategoryId(null);
              setTimeout(() => setErrorMessage(''), 3000);
            } catch (e) {
              addDebugMessage(`Error adding/updating category: ${e.message || e.code}`, "error");
              setErrorMessage(`အမျိုးအစား စီမံရာတွင် အမှားအယွင်းရှိခဲ့ပါသည်။ (${e.message || e.code})`);
            }
          };

          const startEditCategory = (category) => {
            addDebugMessage(`Editing category: ${category.id}`, "action");
            setNewCategoryName(category.name);
            setEditingCategoryId(category.id);
          };

          const confirmDeleteCategory = (id) => {
            addDebugMessage(`Confirming delete for category: ${id}`, "action");
            setCategoryToDeleteId(id);
            setConfirmDeleteCategoryModal(true); // This controls the separate category confirmation modal
          };

          const executeDeleteCategory = async () => {
            addDebugMessage(`Executing delete for category: ${categoryToDeleteId}`, "action");
            if (!db || !dataIdentifier || !categoryToDeleteId) {
              setErrorMessage("User ID မရှိသေးပါ။ သို့မဟုတ် Database မရပါ။");
              addDebugMessage("Validation Error: DB, dataIdentifier or categoryToDeleteId not available for category deletion.", "warning");
              return;
            }
            try {
                // Before deleting category, check if any expenses are using it
                const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
                const expensesCollectionRef = window.firebase.collection(db, `artifacts/${appId}/data_by_identifier/${dataIdentifier}/expenses`);
                const categoryToDeleteName = categories.find(cat => cat.id === categoryToDeleteId)?.name || '';
                addDebugMessage(`Checking for expenses using category: '${categoryToDeleteName}' (ID: ${categoryToDeleteId})`, "info");

                const qExpensesWithCategory = window.firebase.query(expensesCollectionRef, window.firebase.where('category', '==', categoryToDeleteName));
                const expenseUsageSnapshot = await window.firebase.getDocs(qExpensesWithCategory);

                if (!expenseUsageSnapshot.empty) {
                    setErrorMessage("ဤအမျိုးအစားကို အသုံးစရိတ်စာရင်းတွင် အသုံးပြုထားသောကြောင့် ဖျက်၍မရပါ။");
                    addDebugMessage(`Category cannot be deleted: still in use by expenses. Category ID: ${categoryToDeleteId}`, "warning");
                    setConfirmDeleteCategoryModal(false); // Close category confirmation modal
                    setCategoryToDeleteId(null);
                    return;
                }

              await window.firebase.deleteDoc(window.firebase.doc(db, `artifacts/${appId}/data_by_identifier/${dataIdentifier}/categories`, categoryToDeleteId));
              setErrorMessage("အမျိုးအစားကို ဖျက်ပြီးပါပြီ။");
              addDebugMessage(`Category deleted successfully: ${categoryToDeleteId}`, "success");
              setConfirmDeleteCategoryModal(false); // Close category confirmation modal
              setCategoryToDeleteId(null);
              setNewCategoryName(''); // Clear input in case it was being edited
              setEditingCategoryId(null); // Clear editing state
              setTimeout(() => setErrorMessage(''), 3000);
            } catch (e) {
              addDebugMessage(`Error deleting category: ${e.message || e.code}`, "error");
              setErrorMessage(`အမျိုးအစား ဖျက်ရာတွင် အမှားအယွင်းရှိခဲ့ပါသည်။ (${e.message || e.code})`);
            }
          };

          // --- Monthly Summary Calculations and Data Fetching ---
          useEffect(() => {
            if (!db || !dataIdentifier || !showMonthlySummaryModal) {
              setMonthlyTotalExpenses(0);
              setMonthlyTotalIncomes(0);
              return;
            }

            setIsMonthlySummaryLoading(true);
            const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';

            const [year, month] = currentMonth.split('-').map(Number);
            const startOfMonth = new Date(year, month - 1, 1);
            const endOfMonth = new Date(year, month, 0); // Last day of the month

            addDebugMessage(`Fetching monthly summary for ${currentMonth}`, "info");

            const fetchMonthlyData = async () => {
              try {
                const expensesCollectionRef = window.firebase.collection(db, `artifacts/${appId}/data_by_identifier/${dataIdentifier}/expenses`);
                const incomesCollectionRef = window.firebase.collection(db, `artifacts/${appId}/data_by_identifier/${dataIdentifier}/incomes`);

                const qExpensesMonth = window.firebase.query(
                  expensesCollectionRef,
                  window.firebase.where('date', '>=', formatDate(startOfMonth)),
                  window.firebase.where('date', '<=', formatDate(endOfMonth))
                );
                const expensesSnapshot = await window.firebase.getDocs(qExpensesMonth);
                const totalExp = expensesSnapshot.docs.reduce((sum, doc) => sum + parseFloat(doc.data().amount || 0), 0);
                setMonthlyTotalExpenses(totalExp);

                const qIncomesMonth = window.firebase.query(
                  incomesCollectionRef,
                  window.firebase.where('date', '>=', formatDate(startOfMonth)),
                  window.firebase.where('date', '<=', formatDate(endOfMonth))
                );
                const incomesSnapshot = await window.firebase.getDocs(qIncomesMonth);
                const totalInc = incomesSnapshot.docs.reduce((sum, doc) => sum + parseFloat(doc.data().amount || 0), 0);
                setMonthlyTotalIncomes(totalInc);

                addDebugMessage(`Monthly summary fetched for ${currentMonth}: Expenses ${totalExp}, Incomes ${totalInc}`, "info");
              } catch (error) {
                addDebugMessage(`Error fetching monthly data: ${error.message || error.code}`, "error");
                setErrorMessage(`လချုပ်စာရင်း တင်ရာတွင် အမှားအယွင်းရှိခဲ့ပါသည်။ (${error.message || error.code})`);
              } finally {
                setIsMonthlySummaryLoading(false);
              }
            };

            fetchMonthlyData();
          }, [db, dataIdentifier, currentMonth, showMonthlySummaryModal, addDebugMessage]);

          // Handle month navigation (previous/next month)
          const handleMonthChange = (months) => {
            addDebugMessage(`Changing month by ${months} months. Current month: ${currentMonth}`, "action");
            const [year, month] = currentMonth.split('-').map(Number);
            const newDate = new Date(year, month - 1 + months, 1);
            setCurrentMonth(formatMonthYear(newDate));
            addDebugMessage(`New month: ${formatMonthYear(newDate)}`, "info");
          };

          // Handle manual month selection from month input
          const handleManualMonthChange = (e) => {
            addDebugMessage(`Manual month change to: ${e.target.value}`, "action");
            setCurrentMonth(e.target.value);
          };

          // --- Utility function for copying text to clipboard ---
          const copyToClipboard = (text) => {
            addDebugMessage("Attempting to copy text to clipboard.", "action");
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            textArea.style.top = "-999999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
              document.execCommand('copy');
              setShowCopyConfirmation(true);
              addDebugMessage("Text copied successfully.", "success");
              setTimeout(() => setShowCopyConfirmation(false), 2000);
            } catch (err) {
              addDebugMessage(`Error copying to clipboard: ${err.message || err.code}`, "error");
              setErrorMessage('ကူးယူရန် မအောင်မြင်ပါ။');
            }
            document.body.removeChild(textArea);
          };

          // --- Function to handle saving the user-provided data identifier ---
          const handleSaveDataIdentifier = async () => { // Made async to allow logging before Firestore operation
              addDebugMessage(`handleSaveDataIdentifier called. Input value: ${dataIdentifierInput}`, "action");
              if (!dataIdentifierInput.trim()) {
                  setIdErrorMessage("မသိမ်းဆည်းမီ User ID သို့မဟုတ် Nickname ထည့်သွင်းပါ။");
                  addDebugMessage("Validation Error: Data identifier input is empty.", "warning");
                  return;
              }

              if (!db) { // Ensure db is initialized before trying to save
                 setIdErrorMessage("Database မရရှိသေးပါ။ ခဏစောင့်ပြီး ပြန်ကြိုးစားပါ။");
                 addDebugMessage("Validation Error: Database not initialized for data identifier save.", "warning");
                 return;
              }

              setDataIdentifier(dataIdentifierInput.trim());
              setIdErrorMessage(""); // Clear any previous error
              setDataIdentifierSaveSuccess(true); // Show success message
              addDebugMessage(`Data identifier updated to: ${dataIdentifierInput.trim()}`, "success");
              setTimeout(() => {
                  setDataIdentifierSaveSuccess(false); // Hide after 3 seconds
                  setShowDataIdentifierModal(false); // Close modal on success save
              }, 3000);
          };

          // --- Function to reset the data identifier in localStorage ---
          const handleResetDataIdentifier = () => {
              addDebugMessage("Resetting data identifier from localStorage.", "action");
              try {
                  localStorage.removeItem('household_expense_data_identifier');
                  setDataIdentifier('');
                  setDataIdentifierInput(''); // Clear input field
                  setIdErrorMessage('');
                  setDataIdentifierSaveSuccess(false);
                  addDebugMessage("Data identifier successfully reset.", "success");
                  setErrorMessage("User ID ကို ပြန်လည်သတ်မှတ်ပြီးပါပြီ။ ကျေးဇူးပြု၍ ID အသစ်တစ်ခု ထည့်သွင်းပါ။");
              } catch (e) {
                  addDebugMessage(`Error resetting data identifier from localStorage: ${e.message || e.code}`, "error");
                  setErrorMessage(`User ID ပြန်လည်သတ်မှတ်ရာတွင် အမှားအယွင်းရှိခဲ့ပါသည်။ (${e.message || e.code})`);
              }
          };

          // Render a loading spinner if Firebase is still initializing
          if (isLoading) {
            return (
              <div className="min-h-screen bg-gray-100 flex flex-col items-center justify-center font-inter text-gray-800">
                <Loader2 size={48} className="animate-spin text-blue-500 mb-4" />
                <p className="text-lg font-semibold text-gray-700">ဒေတာများ တင်နေသည်...</p>
              </div>
            );
          }

          return (
            <div className="min-h-screen bg-gray-100 flex flex-col font-inter text-gray-800 pb-20"> {/* pb-20 to allow space for fixed input */}
              {/* --- Header Section (Always Visible) --- */}
              <div className="p-4 bg-white shadow-md rounded-b-lg mb-4">
                <div className="flex justify-between items-center mb-3">
                  {/* Previous Day Button */}
                  <button onClick={() => handleDateChange(-1)} className="p-2 bg-blue-500 text-white rounded-full shadow-md focus:outline-none focus:ring-2 focus:ring-blue-300 transform active:scale-95 transition-transform" aria-label="Previous Day">
                    <ChevronLeft size={20} />
                  </button>
                  {/* Current Date Display and Date Picker Toggle */}
                  <div className="relative">
                    <button
                      onClick={() => setShowDatePicker(!showDatePicker)}
                      className="text-base font-semibold text-blue-700 py-1 px-3 rounded-md bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-200 transform active:scale-95 transition-transform"
                      aria-label={`Selected Date: ${new Date(currentDate).toLocaleDateString('my-MM', { weekday: 'short' })}, ${new Date(currentDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`}
                    >
                      {new Date(currentDate).toLocaleDateString('my-MM', { weekday: 'short' })}, {new Date(currentDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                      <CalendarDays size={16} className="inline-block ml-1" />
                    </button>
                    {/* Date Picker Input (conditionally rendered) */}
                    {showDatePicker && (
                      <input
                        type="date"
                        value={currentDate}
                        onChange={handleManualDateChange}
                        className="absolute top-full left-1/2 -translate-x-1/2 mt-2 p-2 border border-gray-300 rounded-md shadow-lg z-10"
                      />
                    )}
                  </div>
                  {/* Next Day Button */}
                  <button onClick={() => handleDateChange(1)} className="p-2 bg-blue-500 text-white rounded-full shadow-md focus:outline-none focus:ring-2 focus:ring-blue-300 transform active:scale-95 transition-transform" aria-label="Next Day">
                    <ChevronRight size={20} />
                  </button>
                </div>

                {/* Summary and Action Buttons */}
                <div className="text-center my-3 flex justify-center space-x-2 flex-wrap">
                    {/* Daily Total Expenses Display */}
                    <div className="bg-red-100 text-red-800 text-sm font-bold py-2 px-4 rounded-full shadow-sm mb-2 mr-2">
                        ယနေ့စုစုပေါင်းထွက်: {dailyTotalExpenses.toLocaleString()} ကျပ်
                    </div>
                    {/* Daily Total Incomes Display */}
                    <div className="bg-green-100 text-green-800 text-sm font-bold py-2 px-4 rounded-full shadow-sm mb-2 mr-2">
                        ယနေ့စုစုပေါင်းဝင်: {dailyTotalIncomes.toLocaleString()} ကျပ်
                    </div>
                    {/* Daily Balance Display */}
                    <div className={`text-sm font-bold py-2 px-4 rounded-full shadow-sm mb-2 mr-2 ${
                        dailyBalance >= 0 ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'
                    }`}>
                        ယနေ့လက်ကျန်: {dailyBalance.toLocaleString()} ကျပ်
                    </div>
                    {/* Monthly Summary Button */}
                    <button
                        onClick={() => { setShowMonthlySummaryModal(true); }}
                        className="inline-flex items-center justify-center px-4 py-2 bg-purple-500 text-white text-sm font-medium rounded-full shadow-md hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-300 transform active:scale-95 transition-transform mb-2 mr-2"
                        title="လချုပ်စာရင်း" aria-label="Monthly Summary"
                    >
                        <CalendarDays size={18} className="mr-2" /> လချုပ်
                    </button>
                    {/* Manage Categories Button */}
                    <button
                        onClick={() => { setShowManageCategoriesModal(true); }}
                        className="inline-flex items-center justify-center px-4 py-2 bg-orange-500 text-white text-sm font-medium rounded-full shadow-md hover:bg-orange-600 focus:outline-none focus:ring-2 focus:ring-orange-300 transform active:scale-95 transition-transform mb-2"
                        title="အမျိုးအစားများ စီမံရန်" aria-label="Manage Categories"
                    >
                        <Tag size={18} className="mr-2" /> အမျိုးအစားများ
                    </button>
                    {/* Add Income Button */}
                    <button
                        onClick={() => { addDebugMessage("Income button clicked. Opening modal.", "action"); setShowAddIncomeModal(true); }}
                        className="inline-flex items-center justify-center px-4 py-2 bg-blue-500 text-white text-sm font-medium rounded-full shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300 transform active:scale-95 transition-transform mb-2"
                        title="ဝင်ငွေထည့်သွင်းရန်" aria-label="Add Income"
                    >
                        <TrendingUp size={18} className="mr-2" /> ဝင်ငွေ
                    </button>
                    {/* User ID / Nickname Button (moved to header) */}
                    <button
                        onClick={() => {
                            addDebugMessage("User ID button clicked. Opening modal.", "action");
                            setShowDataIdentifierModal(true);
                        }}
                        className="inline-flex items-center justify-center px-4 py-2 bg-purple-600 text-white text-sm font-medium rounded-full shadow-md hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-400 transform active:scale-95 transition-transform mb-2"
                        title="User ID သတ်မှတ်ရန်"
                        aria-label="Set User ID"
                    >
                        <User size={18} className="mr-2" /> User ID
                    </button>
                </div>
                {/* Display User ID */}
                {dataIdentifier && (
                  <p className="text-xs text-gray-500 text-center mt-2">
                    လက်ရှိ ID: <span className="font-bold text-gray-700">{dataIdentifier}</span>
                  </p>
                )}
              </div>

              {/* --- Main Content Area - List of Expenses & Incomes --- */}
              <div className="flex-1 flex flex-col w-full px-4 pt-4 overflow-y-auto" style={{ paddingBottom: `${fixedInputAreaHeight + 20}px` }}> {/* Add padding for the fixed input area */}
                {expenses.length === 0 && incomes.length === 0 ? (
                  <p className="text-center text-gray-500 mt-8">ယနေ့အတွက် ဝင်ငွေ သို့မဟုတ် အသုံးစရိတ်များ မရှိသေးပါ။</p>
                ) : (
                  // List of Combined Entries (Expenses first, then Incomes)
                  <div className="space-y-3">
                    {expenses.map(expense => (
                      <div key={expense.id} className="bg-white p-4 rounded-lg shadow-md flex justify-between items-center relative">
                        <div>
                          <p className="text-lg font-semibold text-gray-800">{expense.description}</p>
                          <p className="text-sm text-gray-600">{expense.category}</p>
                          <p className="text-xs text-gray-500 mt-1">
                            {expense.createdAt?.toDate().toLocaleTimeString('my-MM', { hour: '2-digit', minute: '2-digit' }) || ''}
                          </p>
                        </div>
                        <div className="flex flex-col items-end">
                          <p className="text-xl font-bold text-red-600 mb-2">{expense.amount.toLocaleString()} ကျပ်</p> {/* Changed } to } */}
                          <div className="flex space-x-2">
                            <button
                              onClick={() => handleEditExpense(expense)}
                              className="p-1 rounded-full text-blue-500 hover:bg-blue-100 transform active:scale-95 transition-transform" aria-label="Edit Expense"
                            >
                              <Edit size={18} />
                            </button>
                            <button
                              onClick={() => confirmDeleteExpense(expense.id)}
                              className="p-1 rounded-full text-red-500 hover:bg-red-100 transform active:scale-95 transition-transform" aria-label="Delete Expense"
                            >
                              <Trash2 size={18} />
                            </button>
                          </div>
                        </div>
                      </div>
                    ))}
                    {incomes.map(income => ( // Display Incomes
                        <div key={income.id} className="bg-white p-4 rounded-lg shadow-md flex justify-between items-center relative border-l-4 border-green-500">
                            <div>
                                <p className="text-lg font-semibold text-gray-800">{income.description}</p>
                                <p className="text-xs text-gray-500 mt-1">
                                    {income.createdAt?.toDate().toLocaleTimeString('my-MM', { hour: '2-digit', minute: '2-digit' }) || ''}
                                </p>
                            </div>
                            <div className="flex flex-col items-end">
                                <p className="text-xl font-bold text-green-600 mb-2">{income.amount.toLocaleString()} ကျပ်</p>
                                <div className="flex space-x-2">
                                  {/* Edit income not implemented yet, but keeping the slot if needed later */}
                                  {/* <button
                                      onClick={() => handleEditIncome(income)}
                                      className="p-1 rounded-full text-blue-500 hover:bg-blue-100 transform active:scale-95 transition-transform" aria-label="Edit Income"
                                  >
                                      <Edit size={18} />
                                  </button> */}
                                  <button
                                      onClick={() => confirmDeleteIncome(income.id)}
                                      className="p-1 rounded-full text-red-500 hover:bg-red-100 transform active:scale-95 transition-transform" aria-label="Delete Income"
                                  >
                                      <Trash2 size={18} />
                                  </button>
                                </div>
                            </div>
                        </div>
                    ))}
                  </div>
                )}
              </div>

              {/* --- Input Area at the bottom of the screen (fixed position) --- */}
              <div ref={fixedInputAreaRef} className="fixed bottom-0 left-0 right-0 bg-white p-4 shadow-top rounded-t-xl z-30">
                {/* Error Message Display */}
                {errorMessage && (<p className="text-red-600 text-sm mb-2 text-center animate-fade-in-out">{errorMessage}</p>)}

                {/* Input Fields for Expense */}
                <div className="grid grid-cols-1 gap-3 mb-3">
                  <input
                    type="text"
                    placeholder="ဖော်ပြချက်"
                    value={expenseDescription}
                    onChange={(e) => setExpenseDescription(e.target.value)}
                    className="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm placeholder-gray-400"
                    aria-label="Expense Description"
                  />
                  <input
                    type="number"
                    placeholder="ပမာဏ (ကျပ်)"
                    value={expenseAmount}
                    onChange={(e) => setExpenseAmount(e.target.value)}
                    className="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm placeholder-gray-400"
                    aria-label="Expense Amount"
                  />
                  <select
                    value={expenseCategory}
                    onChange={(e) => setExpenseCategory(e.target.value)}
                    className="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm bg-white"
                    aria-label="Expense Category"
                  >
                    <option value="" disabled>အမျိုးအစား ရွေးပါ</option>
                    {categories.length === 0 && <option value="" disabled>အမျိုးအစားမရှိသေးပါ</option>}
                    {categories.map(cat => (
                      <option key={cat.id} value={cat.name}>{cat.name}</option>
                    ))}
                  </select>
                </div>

                {/* Add/Update Button */}
                <div className="flex justify-end">
                    <button
                        onClick={handleAddOrUpdateExpense}
                        className="p-4 bg-gradient-to-br from-blue-600 to-blue-700 text-white rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 active:scale-95 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2"
                        aria-label={editingExpenseId ? "Update Expense" : "Add Expense"}
                    >
                        <Plus size={28} /> {/* Plus icon */}
                    </button>
                </div>
                <div className="h-8"></div> {/* Spacer for bottom padding (approx. two lines of text) */}
              </div>

              {/* --- App Debug Log Section --- */}
              <div className="bg-gradient-to-br from-gray-50 to-gray-100 p-4 mx-4 my-4 rounded-lg shadow-md text-sm border border-blue-200"> {/* Added gradient, border */}
                  <div className="flex justify-between items-center mb-2">
                      <h3 className="text-base font-semibold text-gray-700 flex items-center">
                          <Info size={16} className="mr-1 text-blue-500" /> App Debug Log
                      </h3>
                      <button
                          onClick={() => setDebugMessages([])}
                          className="px-3 py-1 bg-gray-200 text-gray-700 rounded-md text-xs hover:bg-gray-300 transform active:scale-95 transition-transform"
                      >
                          Clear Logs
                      </button>
                  </div>
                  <div ref={debugLogRef} className="bg-white p-2 rounded-md h-40 overflow-y-auto border border-gray-200 hide-scrollbar">
                      {debugMessages.length === 0 ? (
                          <p className="text-gray-400 italic">No debug messages yet.</p>
                      ) : (
                          debugMessages.map((msg, index) => (
                              <p key={index} className={`mb-1 ${msg.type === 'error' ? 'text-red-600 font-medium' : msg.type === 'warning' ? 'text-orange-600' : msg.type === 'success' ? 'text-green-600' : 'text-gray-700'}`}>
                                  <span className="text-gray-500 mr-2">[{msg.timestamp}]</span> {msg.message}
                              </p>
                          ))
                      )}
                  </div>
              </div>


              {/* --- Modals Section (Conditionally Rendered) --- */}

              {/* User Data Identifier Modal */}
              {showDataIdentifierModal && (
                <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-lg shadow-xl w-full max-w-sm flex flex-col">
                    {/* Modal Header */}
                    <div className="flex justify-between items-center p-4 border-b">
                      <h2 className="text-lg font-bold text-blue-700">User ID သို့မဟုတ် Nickname သတ်မှတ်ရန်</h2>
                      <button onClick={() => setShowDataIdentifierModal(false)} className="text-gray-500 hover:text-gray-700 transform active:scale-95 transition-transform" aria-label="Close User ID Modal">
                        <X size={24} />
                      </button>
                    </div>
                    {/* Modal Content */}
                    <div className="p-4">
                      <p className="text-sm text-gray-700 font-semibold mb-3">
                          သင့်ဒေတာများကို သိမ်းဆည်းရန် မှတ်မိလွယ်သော ID/Nickname ထည့်ပါ။
                      </p>
                      {idErrorMessage && (<p className="text-red-600 text-sm mb-2 text-center">{idErrorMessage}</p>)}
                      {dataIdentifierSaveSuccess && (<p className="text-green-600 text-sm mb-2 text-center animate-fade-in-out">User ID ကို အောင်မြင်စွာ သိမ်းဆည်းပြီးပါပြီ။</p>)}
                      <div className="flex flex-col space-y-3">
                        <input
                          type="text"
                          value={dataIdentifierInput}
                          onChange={(e) => {
                              addDebugMessage(`User ID Input changed: ${e.target.value}`, "input");
                              setDataIdentifierInput(e.target.value);
                              setIdErrorMessage(''); // Clear error on change
                              setDataIdentifierSaveSuccess(false); // Hide success message on input change
                          }}
                          placeholder="User ID သို့မဟုတ် Nickname ထည့်ပါ"
                          className="p-2 border border-blue-300 rounded-md focus:outline-none focus:ring-1 focus:ring-blue-400 text-sm"
                          aria-label="User Data Identifier Input"
                        />
                        <button
                          onClick={handleSaveDataIdentifier}
                          className="px-4 py-2 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 transform active:scale-95 transition-transform text-sm"
                        >
                          User ID သိမ်းမည်
                        </button>
                        <button
                          onClick={handleResetDataIdentifier}
                          className="px-4 py-2 bg-red-500 text-white rounded-lg shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 transform active:scale-95 transition-transform text-sm"
                        >
                          User ID ပြန်လည်သတ်မှတ်မည်
                        </button>
                      </div>
                      {dataIdentifier && (
                          <p className="text-xs text-gray-500 text-center mt-3 p-2 bg-gray-50 rounded-md border border-gray-200">
                              လက်ရှိ ID: <span className="font-bold text-gray-700">{dataIdentifier}</span>
                              <br/>
                              <span className="text-red-500 font-bold">သတိ: ဤ ID ကိုသိသူတိုင်း သင့်ဒေတာကို ဝင်ရောက်နိုင်ပါသည်။</span>
                          </p>
                      )}
                    </div>
                  </div>
                </div>
              )}

              {/* Add Income Modal */}
              {showAddIncomeModal && (
                <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-lg shadow-xl w-full max-w-sm flex flex-col">
                    {/* Modal Header */}
                    <div className="flex justify-between items-center p-4 border-b">
                      <h2 className="text-lg font-bold text-blue-700">ဝင်ငွေ ထည့်သွင်းရန်</h2>
                      <button onClick={() => { setShowAddIncomeModal(false); setIncomeDescription(''); setIncomeAmount(''); setErrorMessage(''); }} className="text-gray-500 hover:text-gray-700 transform active:scale-95 transition-transform" aria-label="Close Add Income Modal">
                        <X size={24} />
                      </button>
                    </div>
                    {/* Modal Content */}
                    <div className="p-4">
                      {errorMessage && (<p className="text-red-600 text-sm mb-2 text-center animate-fade-in-out">{errorMessage}</p>)}
                      <div className="flex flex-col space-y-3">
                        <input
                          type="text"
                          placeholder="ဖော်ပြချက် (ဥပမာ: လစာ)"
                          value={incomeDescription}
                          onChange={(e) => { setIncomeDescription(e.target.value); setErrorMessage(''); }}
                          className="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm placeholder-gray-400"
                          aria-label="Income Description"
                        />
                        <input
                          type="number"
                          placeholder="ပမာဏ (ကျပ်)"
                          value={incomeAmount}
                          onChange={(e) => { setIncomeAmount(e.target.value); setErrorMessage(''); }}
                          className="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm placeholder-gray-400"
                          aria-label="Income Amount"
                        />
                        <button
                          onClick={handleAddIncome}
                          className="px-4 py-3 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400 transform active:scale-95 transition-transform text-lg font-semibold"
                          aria-label="Add Income"
                        >
                          ထည့်မည်
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              )}


              {/* Monthly Summary Modal */}
              {showMonthlySummaryModal && (
                <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-40">
                  <div className="bg-white rounded-lg shadow-xl w-full max-w-sm max-h-[90vh] flex flex-col relative">
                    {/* Modal Header */}
                    <div className="flex justify-between items-center p-4 border-b">
                      <h2 className="text-lg font-bold text-purple-700">လချုပ်စာရင်း ({currentMonth})</h2>
                      <button onClick={() => setShowMonthlySummaryModal(false)} className="text-gray-500 hover:text-gray-700 transform active:scale-95 transition-transform" aria-label="Close Monthly Summary">
                        <X size={24} />
                      </button>
                    </div>

                    {/* Loading State for Monthly Summary */}
                    {isMonthlySummaryLoading ? (
                      <div className="flex-1 flex flex-col items-center justify-center p-8">
                        <Loader2 size={40} className="animate-spin text-purple-500 mb-4" />
                        <p className="text-md text-gray-600">လချုပ်ဒေတာများ တင်နေသည်...</p>
                      </div>
                    ) : (
                      <>
                      <div className="p-4 flex-1 overflow-y-auto">
                        {/* Month Navigation */}
                        <div className="flex justify-center items-center space-x-2 mb-4">
                          <button onClick={() => handleMonthChange(-1)} className="p-2 bg-purple-100 text-purple-700 rounded-full focus:outline-none focus:ring-2 focus:ring-purple-300 transform active:scale-95 transition-transform" aria-label="Previous Month">
                            <ChevronLeft size={20} />
                          </button>
                          <input
                            type="month"
                            value={currentMonth}
                            onChange={handleManualMonthChange}
                            className="p-2 border border-gray-300 rounded-md text-center text-base font-semibold focus:outline-none focus:ring-1 focus:ring-purple-400"
                            aria-label="Select Month"
                          />
                          <button onClick={() => handleMonthChange(1)} className="p-2 bg-purple-100 text-purple-700 rounded-full focus:outline-none focus:ring-2 focus:ring-purple-300 transform active:scale-95 transition-transform" aria-label="Next Month">
                            <ChevronRight size={20} />
                          </button>
                        </div>

                        {/* Monthly Summary Data Display */}
                        <div className="grid grid-cols-1 gap-3 text-base text-center">
                            <div className="bg-green-50 p-3 rounded-lg flex justify-between items-center shadow-sm">
                                <span className="font-medium text-green-700">စုစုပေါင်းဝင်ငွေ:</span>
                                <span className="font-bold text-xl text-green-800">{monthlyTotalIncomes.toLocaleString()} ကျပ်</span>
                            </div>
                            <div className="bg-red-50 p-3 rounded-lg flex justify-between items-center shadow-sm">
                                <span className="font-medium text-red-700">စုစုပေါင်းအသုံးစရိတ်:</span>
                                <span className="font-bold text-xl text-red-800">{monthlyTotalExpenses.toLocaleString()} ကျပ်</span>
                            </div>
                            <div className={`p-3 rounded-lg flex justify-between items-center font-bold text-xl ${
                                (monthlyTotalIncomes - monthlyTotalExpenses) >= 0 ? 'bg-blue-100 text-blue-800' : 'bg-yellow-100 text-yellow-800'
                            } shadow-md mt-2`}>
                                <span className="font-medium">ကွာခြားမှု:</span>
                                <span>{(monthlyTotalIncomes - monthlyTotalExpenses).toLocaleString()} ကျပ်</span>
                            </div>
                        </div>
                      </div>
                      {/* Modal Footer with Copy Button */}
                      {(monthlyTotalIncomes > 0 || monthlyTotalExpenses > 0) && (
                        <div className="p-4 border-t text-center">
                            <button
                                onClick={() => {
                                    const textToCopy = `လချုပ်စာရင်း (${currentMonth})\nစုစုပေါင်းဝင်ငွေ: ${monthlyTotalIncomes.toLocaleString()} ကျပ်\nစုစုပေါင်းအသုံးစရိတ်: ${monthlyTotalExpenses.toLocaleString()} ကျပ်\nကွာခြားမှု: ${(monthlyTotalIncomes - monthlyTotalExpenses).toLocaleString()} ကျပ်`;
                                    copyToClipboard(textToCopy);
                                }}
                                className="flex items-center justify-center w-full px-4 py-2 bg-green-600 text-white rounded-lg shadow-md hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-400 transform active:scale-95 transition-transform"
                                aria-label="Copy Monthly Summary"
                            >
                                <Copy size={20} className="mr-2" /> ကူးယူမည်
                            </button>
                        </div>
                      )}
                      </>
                    )}
                    {showCopyConfirmation && (
                      <div className="absolute top-4 left-1/2 -translate-x-1/2 bg-green-500 text-white px-4 py-2 rounded-md shadow-lg z-50 animate-fade-in-out">
                        စာရင်းကို ကူးယူပြီးပါပြီ။
                      </div>
                    )}
                  </div>
                </div>
              )}

              {/* Manage Categories Modal */}
              {showManageCategoriesModal && (
                <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-40">
                  <div className="bg-white rounded-lg shadow-xl w-full max-w-md max-h-[90vh] flex flex-col">
                    {/* Modal Header */}
                    <div className="flex justify-between items-center p-4 border-b">
                      <h2 className="text-lg font-bold text-orange-700">အမျိုးအစားများ စီမံရန်</h2>
                      <button onClick={() => { setShowManageCategoriesModal(false); setNewCategoryName(''); setEditingCategoryId(null); setErrorMessage(''); }} className="text-gray-500 hover:text-gray-700 transform active:scale-95 transition-transform" aria-label="Close Manage Categories">
                        <X size={24} />
                      </button>
                    </div>
                    {/* Modal Content */}
                    <div className="p-4">
                      {errorMessage && (<p className="text-red-600 text-sm mb-2 text-center animate-fade-in-out">{errorMessage}</p>)}
                      {/* Add/Edit Category Input and Button */}
                      <div className="flex space-x-2 mb-4">
                        <input
                          type="text"
                          value={newCategoryName}
                          onChange={(e) => { setNewCategoryName(e.target.value); setErrorMessage(''); }}
                          placeholder="အမျိုးအစားနာမည် ထည့်/ပြင်ဆင်ပါ"
                          className="flex-1 p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-orange-400"
                          aria-label="Category Name Input"
                        />
                        <button
                          onClick={handleAddOrUpdateCategory}
                          className="px-4 py-2 bg-orange-600 text-white rounded-md shadow-md hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-orange-400 transform active:scale-95 transition-transform"
                        >
                          {editingCategoryId ? 'ပြင်ဆင်မည်' : 'ထည့်မည်'}
                        </button>
                      </div>
                      <h3 className="text-md font-bold text-gray-700 mb-2">လက်ရှိ အမျိုးအစားများ:</h3>
                      {/* List of Existing Categories */}
                      <div className="max-h-60 overflow-y-auto hide-scrollbar border border-gray-200 rounded-md p-2">
                        {categories.length === 0 ? (
                          <p className="text-center text-gray-500 text-sm">အမျိုးအစားမရှိသေးပါ။</p>
                        ) : (
                          categories.map(category => (
                            <div key={category.id} className="flex justify-between items-center bg-gray-50 p-2 rounded-md mb-2 shadow-sm">
                              <span className="text-gray-700 font-medium">{category.name}</span>
                              <div className="flex space-x-2">
                                <button onClick={() => startEditCategory(category)} className="p-1 rounded-full text-blue-500 hover:bg-blue-100 transform active:scale-95 transition-transform" aria-label="Edit Category">
                                  <Edit size={16} />
                                </button>
                                <button onClick={() => confirmDeleteCategory(category.id)} className="p-1 rounded-full text-red-500 hover:bg-red-100 transform active:scale-95 transition-transform" aria-label="Delete Category">
                                  <Trash2 size={16} />
                                </button>
                              </div>
                            </div>
                          ))
                        )}
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Custom Delete Confirmation Modal (for expenses) */}
              {showConfirmDeleteExpenseModal && (
                <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-lg shadow-xl w-full max-w-xs">
                    {/* Modal Header */}
                    <div className="flex justify-between items-center p-4 border-b bg-yellow-100">
                      <h2 className="text-lg font-bold text-yellow-700">အတည်ပြုရန်</h2>
                      <button onClick={() => setShowConfirmDeleteExpenseModal(false)} className="text-yellow-500 hover:text-yellow-700 transform active:scale-95 transition-transform" aria-label="Close Confirmation">
                        <X size={24} />
                      </button>
                    </div>
                    {/* Modal Content */}
                    <div className="p-4 text-center">
                      <p className="text-sm text-gray-700 mb-4">ဤအသုံးစရိတ်ကို ဖျက်ရန် သေချာပါလား။</p>
                      <div className="flex justify-around space-x-4">
                        <button
                          onClick={() => setShowConfirmDeleteExpenseModal(false)}
                          className="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg shadow-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300 transform active:scale-95 transition-transform"
                        >
                          မဖျက်တော့ဘူး
                        </button>
                        <button
                          onClick={executeDeleteExpense}
                          className="px-6 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-400 transform active:scale-95 transition-transform"
                        >
                          ဖျက်မည်
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* NEW: Custom Delete Confirmation Modal (for incomes) */}
              {showConfirmDeleteIncomeModal && (
                <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-lg shadow-xl w-full max-w-xs">
                    {/* Modal Header */}
                    <div className="flex justify-between items-center p-4 border-b bg-yellow-100">
                      <h2 className="text-lg font-bold text-yellow-700">အတည်ပြုရန်</h2>
                      <button onClick={() => setShowConfirmDeleteIncomeModal(false)} className="text-yellow-500 hover:text-yellow-700 transform active:scale-95 transition-transform" aria-label="Close Confirmation">
                        <X size={24} />
                      </button>
                    </div>
                    {/* Modal Content */}
                    <div className="p-4 text-center">
                      <p className="text-sm text-gray-700 mb-4">ဤဝင်ငွေကို ဖျက်ရန် သေချာပါလား။</p>
                      <div className="flex justify-around space-x-4">
                        <button
                          onClick={() => setShowConfirmDeleteIncomeModal(false)}
                          className="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg shadow-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300 transform active:scale-95 transition-transform"
                        >
                          မဖျက်တော့ဘူး
                        </button>
                        <button
                          onClick={executeDeleteIncome}
                          className="px-6 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-400 transform active:scale-95 transition-transform"
                        >
                          ဖျက်မည်
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Category Delete Confirmation Modal (Uses the same UI as expense delete) */}
              {confirmDeleteCategoryModal && ( // This state is separate from expense confirmation
                <div className="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 z-50">
                  <div className="bg-white rounded-lg shadow-xl w-full max-w-xs">
                    {/* Modal Header */}
                    <div className="flex justify-between items-center p-4 border-b bg-yellow-100">
                      <h2 className="text-lg font-bold text-yellow-700">အတည်ပြုရန်</h2>
                      <button onClick={() => setConfirmDeleteCategoryModal(false)} className="text-yellow-500 hover:text-yellow-700 transform active:scale-95 transition-transform" aria-label="Close Confirmation">
                        <X size={24} />
                      </button>
                    </div>
                    {/* Modal Content */}
                    <div className="p-4 text-center">
                      <p className="text-sm text-gray-700 mb-4">ဤအမျိုးအစားကို ဖျက်ရန် သေချာပါလား။</p>
                      <div className="flex justify-around space-x-4">
                        <button
                          onClick={() => setConfirmDeleteCategoryModal(false)}
                          className="px-6 py-2 bg-gray-300 text-gray-800 rounded-lg shadow-md hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300 transform active:scale-95 transition-transform"
                        >
                          မဖျက်တော့ဘူး
                        </button>
                        <button
                          onClick={executeDeleteCategory}
                          className="px-6 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-400 transform active:scale-95 transition-transform"
                        >
                          ဖျက်မည်
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          );
        };

        // Render the App component
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>

